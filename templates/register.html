{% extends 'base.html' %}
{% block title %}Crear Cuenta - FinanzApp{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/iniciar_sesion.css') }}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
{% endblock %}

{% block content %}
<div id="loader-screen">
    <svg class="svg-loader" x="0px" y="0px" viewBox="0 0 37 37" preserveAspectRatio="xMidYMid meet">
        <path class="track" fill="none" stroke-width="5" pathLength="100"
            d="M36.63 31.746 c0 -13.394 -7.3260000000000005 -25.16 -18.13 -31.375999999999998 C7.696 6.66 0.37 18.352 0.37 31.746 c5.328 3.108 11.544 4.8839999999999995 18.13 4.8839999999999995 S31.301999999999996 34.854 36.63 31.746z">
        </path>
        <path class="car" fill="none" stroke-width="5" pathLength="100"
            d="M36.63 31.746 c0 -13.394 -7.3260000000000005 -25.16 -18.13 -31.375999999999998 C7.696 6.66 0.37 18.352 0.37 31.746 c5.328 3.108 11.544 4.8839999999999995 18.13 4.8839999999999995 S31.301999999999996 34.854 36.63 31.746z">
        </path>
    </svg>
    <p class="loader-text">Creando tu cuenta...</p>
</div>

<div class="contenedor">
    <div class="lado-izquierdo">
        <div class="formulario">
            <div class="text-center mb-4 d-md-none">
                <img src="{{ url_for('static', filename='multimedia/logo.png') }}" style="width: 60px;">
            </div>
            <h2>Comienza Hoy</h2>
            <p>Ingresa tus datos para crear una cuenta. ¿Ya tienes una? <a href="{{ url_for('login') }}">Inicia
                    sesión</a></p>

            <form id="registerForm">
                <input type="text" placeholder="Nombre completo" name="name" required id="name" maxlength="50">
                <input type="email" placeholder="Correo electrónico" name="email" required id="email" maxlength="100">

                <div class="input-container">
                    <input type="password" id="password" name="password" placeholder="Contraseña" required
                        maxlength="25">
                    <span id="eye-icon-password" class="fa fa-eye"
                        onclick="togglePasswordVisibility('password')"></span>
                </div>

                <!-- Password Checklist -->
                <ul class="password-checklist">
                    <li id="rule-length" class="check-item"><i class="fa fa-circle-check"></i> Mínimo 8 caracteres</li>
                    <li id="rule-upper" class="check-item"><i class="fa fa-circle-check"></i> Una mayúscula</li>
                    <li id="rule-special" class="check-item"><i class="fa fa-circle-check"></i> Un número o símbolo</li>
                </ul>

                <div class="input-container mt-2">
                    <input type="password" id="confirm_password" name="confirm_password"
                        placeholder="Confirmar Contraseña" required maxlength="25">
                    <span id="eye-icon-confirm" class="fa fa-eye"
                        onclick="togglePasswordVisibility('confirm_password')"></span>
                </div>

                <p class="terms-text" style="font-size: 0.85rem; color: #64748B; margin-top: 1rem;">
                    Al registrarte, aceptas nuestros <a id="termsLink" href="#"
                        style="color: #D97706; text-decoration: none; font-weight: 600;">términos y condiciones</a> y
                    política de privacidad.
                </p>

                <div id="password-match-msg" style="font-size: 0.85rem; color: #DC2626; display: none;">Las contraseñas
                    no coinciden</div>

                <button type="submit" class="boton-principal" id="submitBtn" disabled>Crear Cuenta</button>

                <div class="separator">o regístrate con</div>

                <a href="{{ url_for('google_login') }}" class="boton-google">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" width="24px" height="24px">
                        <path fill="#FFC107"
                            d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24c0,11.045,8.955,20,20,20c11.045,0,20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z" />
                        <path fill="#FF3D00"
                            d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z" />
                        <path fill="#4CAF50"
                            d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z" />
                        <path fill="#1976D2"
                            d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.571c0.001-0.001,0.002-0.001,0.003-0.002l6.19,5.238C36.971,39.205,44,34,44,24C44,22.659,43.862,21.35,43.611,20.083z" />
                    </svg> Google
                </a>
            </form>
        </div>
    </div>

    <div class="lado-derecho">
        <div class="logo-overlay">
            <img src="{{ url_for('static', filename='multimedia/logo.png') }}" alt="FinanzApp">
        </div>
        <video autoplay loop muted playsinline>
            <source src="{{ url_for('static', filename='multimedia/video_login.mp4') }}" type="video/mp4">
        </video>
        <a href="{{ url_for('index') }}" class="boton-volver">
            <i class="fas fa-arrow-left"></i> Volver al inicio
        </a>
    </div>
</div>

<!-- Alerts -->
<div id="error-message-overlay" class="error-message-overlay">
    <div class="error-message-box">
        <p id="error-message-text"></p>
    </div>
</div>

<!-- Terms Modal -->
<div id="terms-modal" class="modal-overlay">
    <div class="modal-content">
        <span class="close-modal" id="closeTerms">&times;</span>
        <h3>Términos y condiciones</h3>
        <div class="terms-body">
            <h5>1. Aceptación de términos</h5>
            <p>Al registrarse y utilizar FinanzApp, usted confirma que tiene mayoría de edad legal y capacidad para
                contraer acuerdos vinculantes.</p>

            <h5>2. Licencia de uso</h5>
            <p>Concedemos una licencia limitada, no exclusiva e intransferible para usar el servicio estrictamente para
                fines personales y no comerciales.</p>

            <h5>3. Privacidad y seguridad</h5>
            <p>Su privacidad es primordial. Empleamos encriptación de grado militar (AES-256). Consulte nuestra Política
                de Privacidad para detalles sobre el manejo de datos.</p>

            <h5>4. Propiedad intelectual</h5>
            <p>Todo el contenido, marcas, logotipos y algoritmos son propiedad exclusiva de FinanzApp Inc. Queda
                prohibida su reproducción sin autorización.</p>

            <h5>5. Exactitud de la información</h5>
            <p>Aunque nos esforzamos por la precisión, no garantizamos que los análisis automatizados estén libres de
                errores. Usted debe verificar sus datos antes de tomar decisiones críticas.</p>

            <h5>6. Responsabilidad limitada</h5>
            <p>FinanzApp no será responsable por daños indirectos, pérdida de beneficios o datos derivados del uso o
                imposibilidad de uso del servicio.</p>

            <h5>7. Tarifas y pagos</h5>
            <p>Ciertas funciones premium pueden requerir pago. Las tarifas se cobrarán por adelantado y no son
                reembolsables, salvo disposición legal contraria.</p>

            <h5>8. Modificaciones del servicio</h5>
            <p>Nos reservamos el derecho de modificar o discontinuar temporal o permanentemente el servicio con o sin
                previo aviso.</p>

            <h5>9. Conducta del usuario</h5>
            <p>Usted acepta no utilizar el servicio para actividades ilícitas, fraudulentas o que violen derechos de
                terceros.</p>

            <h5>10. Cancelación y terminación</h5>
            <p>Puede cerrar su cuenta en cualquier momento. Nosotros podemos suspender su acceso si viola estos
                términos.
            </p>

            <h5>11. Enlaces a terceros</h5>
            <p>El servicio puede contener enlaces a sitios externos que no operamos. No somos asesores financieros y el
                contenido de terceros es responsabilidad de sus autores.</p>

            <h5>12. Jurisdicción</h5>
            <p>Estos términos se rigen por las leyes locales de su país de residencia. Cualquier disputa se resolverá en
                los tribunales competentes de dicha jurisdicción.</p>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function togglePasswordVisibility(id) {
        const input = document.getElementById(id);
        const iconId = id === 'password' ? 'eye-icon-password' : 'eye-icon-confirm';
        const icon = document.getElementById(iconId);
        if (input.type === "password") {
            input.type = "text"; icon.classList.replace('fa-eye', 'fa-eye-slash');
        } else {
            input.type = "password"; icon.classList.replace('fa-eye-slash', 'fa-eye');
        }
    }

    // Password Real-time Validation
    const passInput = document.getElementById('password');
    const confirmInput = document.getElementById('confirm_password');
    const submitBtn = document.getElementById('submitBtn');
    const matchMsg = document.getElementById('password-match-msg');

    const ruleLength = document.getElementById('rule-length');
    const ruleUpper = document.getElementById('rule-upper');
    const ruleSpecial = document.getElementById('rule-special');
    // const termsCheckbox = document.getElementById('terms'); // Removed

    // Terms Modal Logic
    const termsModal = document.getElementById('terms-modal');
    const closeTermsBtn = document.getElementById('closeTerms');
    const termsLink = document.getElementById('termsLink');

    if (termsLink && termsModal) {
        termsLink.addEventListener('click', (e) => {
            e.preventDefault();
            termsModal.style.display = 'flex';
        });
    }

    if (closeTermsBtn && termsModal) {
        closeTermsBtn.addEventListener('click', () => {
            termsModal.style.display = 'none';
        });
    }

    window.addEventListener('click', (e) => {
        if (termsModal && e.target === termsModal) {
            termsModal.style.display = 'none';
        }
    });

    function validateForm() {
        const val = passInput.value;
        const confirmVal = confirmInput.value;
        // const isTermsChecked = termsCheckbox.checked; // Removed

        const isLength = val.length >= 8;
        const isUpper = /[A-Z]/.test(val);
        const isSpecial = /[0-9!@#$%^&*]/.test(val);
        const isMatch = val === confirmVal && val !== '';

        // Update UI
        ruleLength.classList.toggle('valid', isLength);
        ruleUpper.classList.toggle('valid', isUpper);
        ruleSpecial.classList.toggle('valid', isSpecial);

        if (confirmVal.length > 0 && !isMatch) {
            matchMsg.style.display = 'block';
        } else {
            matchMsg.style.display = 'none';
        }

        // Removed isTermsChecked from condition
        if (isLength && isUpper && isSpecial && isMatch) {
            submitBtn.disabled = false;
        } else {
            submitBtn.disabled = true;
        }
    }

    passInput.addEventListener('input', validateForm);
    confirmInput.addEventListener('input', validateForm);
    // termsCheckbox.addEventListener('change', validateForm); // Removed

    // Form Submit
    document.getElementById('registerForm').addEventListener('submit', function (e) {
        e.preventDefault();
        const loader = document.getElementById('loader-screen');
        loader.style.display = 'flex';

        fetch('/register', { method: 'POST', body: new FormData(this) })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    // Success: Keep loader, wait 2s, then redirect
                    const loaderText = document.querySelector('#loader-screen p');
                    if (loaderText) loaderText.innerText = "¡Cuenta creada! Redirigiendo...";

                    setTimeout(() => {
                        window.location.href = data.redirect + "?new_user=true";
                    }, 2000);
                }
                else {
                    // Error: Hide loader immediately
                    loader.style.display = 'none';
                    const errBox = document.getElementById('error-message-overlay');
                    document.getElementById('error-message-text').innerText = data.message;
                    errBox.classList.add('show');
                    setTimeout(() => errBox.classList.remove('show'), 3000);
                }
            })
            .catch(error => {
                loader.style.display = 'none';
                console.error('Error:', error);
                const errBox = document.getElementById('error-message-overlay');
                document.getElementById('error-message-text').innerText = "Ocurrió un error inesperado, intenta nuevamente.";
                errBox.classList.add('show');
                setTimeout(() => errBox.classList.remove('show'), 3000);
            });
    });
</script>
{% endblock %}