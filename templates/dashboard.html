{% extends 'base.html' %}

{% block title %}Dashboard - FinanzApp{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <!-- Loader -->
    <div id="loader-screen">
        <svg class="svg-loader" x="0px" y="0px" viewBox="0 0 37 37" preserveAspectRatio="xMidYMid meet">
            <path class="track" fill="none" stroke-width="5" pathLength="100"
                d="M36.63 31.746 c0 -13.394 -7.3260000000000005 -25.16 -18.13 -31.375999999999998 C7.696 6.66 0.37 18.352 0.37 31.746 c5.328 3.108 11.544 4.8839999999999995 18.13 4.8839999999999995 S31.301999999999996 34.854 36.63 31.746z">
            </path>
            <path class="car" fill="none" stroke-width="5" pathLength="100"
                d="M36.63 31.746 c0 -13.394 -7.3260000000000005 -25.16 -18.13 -31.375999999999998 C7.696 6.66 0.37 18.352 0.37 31.746 c5.328 3.108 11.544 4.8839999999999995 18.13 4.8839999999999995 S31.301999999999996 34.854 36.63 31.746z">
            </path>
        </svg>
        <p class="loader-text">Preparando tus finanzas...</p>
    </div>
    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="sidebar-header d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center gap-2 text-decoration-none" style="cursor: default;">
                <img src="{{ url_for('static', filename='multimedia/logo.png') }}" alt="FinanzApp Logo">
                <span>FinanzApp</span>
            </div>
            <button id="closeSidebar" class="d-lg-none btn btn-link text-white">
                <i class="bi bi-x-lg"></i>
            </button>
        </div>

        <ul class="nav-links mt-4">
            <li class="nav-item">
                <a href="#" class="nav-link active" onclick="showSection('dashboard')">
                    <i class="bi bi-grid-1x2-fill"></i>
                    <span>Panel de control</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="#" class="nav-link" onclick="showSection('movements')">
                    <i class="bi bi-arrow-left-right"></i>
                    <span>Movimientos</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="#" class="nav-link" onclick="showSection('calendar')">
                    <i class="bi bi-calendar-event"></i>
                    <span>Calendario</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="#" class="nav-link" onclick="showSection('reports')">
                    <i class="bi bi-file-earmark-bar-graph-fill"></i>
                    <span>Reportes</span>
                </a>

            <li class="nav-item">
                <a href="#" class="nav-link" onclick="showSection('budgets')">
                    <i class="bi bi-wallet2"></i>
                    <span>Presupuestos</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="#" class="nav-link" onclick="showSection('goals')">
                    <i class="bi bi-bullseye"></i>
                    <span>Metas de ahorro</span>
                </a>
            </li>

            <li class="nav-item">
                <a href="#" class="nav-link" onclick="showSection('ai-assistant')">
                    <i class="bi bi-robot"></i>
                    <span>Asistente IA</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="#" class="nav-link" onclick="showSection('profile')">
                    <i class="bi bi-person-circle"></i>
                    <span>Mi perfil</span>
                </a>
            </li>
        </ul>

        <div class="logout-container">
            <a href="{{ url_for('logout') }}" class="logout-btn">
                <i class="bi bi-box-arrow-right"></i>
                <span>Cerrar sesión</span>
            </a>
        </div>
    </aside>

    <!-- Main Content -->
    <!-- Main Content Wrapper -->
    <div class="main-wrapper">
        <!-- Top Navbar -->
        <header class="top-navbar">
            <div class="d-flex align-items-center gap-3">
                <button id="openSidebar" class="d-lg-none btn btn-link p-0 text-body">
                    <i class="bi bi-list fs-3"></i>
                </button>
            </div>

            <div class="top-actions">
                <!-- Theme Toggle -->
                <button id="theme-toggle" class="theme-toggle-btn" aria-label="Cambiar tema">
                    <i class="fas fa-moon"></i>
                </button>

                <div class="user-profile" id="userProfileBtn">
                    <div class="user-info text-end d-none d-md-block">
                        <span class="user-name">{{ name }}</span>
                        <span class="user-plan">Plan gratuito</span>
                    </div>
                    <div class="user-avatar ms-2">
                        {{ name[0] | upper }}
                    </div>
                    <i class="bi bi-chevron-down ms-2 transition-icon" id="profileChevron"></i>

                    <!-- Dropdown Menu -->
                    <div class="profile-dropdown" id="profileDropdown">
                        <div class="dropdown-header">
                            <span class="d-block fw-bold">{{ name }}</span>
                            <span class="d-block text-muted small">Plan gratuito</span>
                        </div>
                        <ul class="dropdown-menu-list">
                            <li><a href="#" onclick="showSection('profile')"><i class="bi bi-person"></i> Mi perfil</a>
                            </li>
                            <li><a href="#" onclick="openFAQModal()"><i class="bi bi-question-circle"></i> Ayuda y
                                    soporte</a></li>
                            <li class="dropdown-divider"></li>
                            <li><a href="#" class="text-danger" id="logoutInfoDrop"><i
                                        class="bi bi-box-arrow-right"></i> Cerrar sesión</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Dashboard Section -->
        <div class="container-fluid px-4 mt-3">
            <!-- Toasts Container -->
            <div id="toast-container" class="toast-container"></div>

            {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
            <script id="flash-messages" type="application/json">
                {{ messages | tojson | safe }}
            </script>
            {% endif %}
            {% endwith %}
        </div>

        <div class="content-body fade-in" id="section-dashboard">
            {% if transactions %}
            <!-- Welcome Section (Mobile/Desktop) -->
            <div class="welcome-section mb-4">
                <h2 class="fw-bold mb-1">Hola, {{ name }}</h2>
                <p class="text-muted">Aquí está el resumen de tus finanzas hoy.</p>
            </div>

            <!-- Stats Grid -->
            <div class="stats-grid">
                <div class="stat-card featured">
                    <div class="stat-header">
                        <span>Balance total</span>
                        <div class="stat-icon"><i class="bi bi-currency-dollar"></i></div>
                    </div>
                    <div class="stat-value">${{ balance }}</div>
                    <div class="stat-trend positive">
                        <i class="bi bi-arrow-up-short"></i> +2.5% vs mes anterior
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-header">
                        <span>Ingresos</span>
                        <div class="stat-icon"><i class="bi bi-download"></i></div>
                    </div>
                    <div class="stat-value">${{ total_income }}</div>
                    <div class="stat-trend neutral">
                        Este mes
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-header">
                        <span>Gastos</span>
                        <div class="stat-icon"><i class="bi bi-upload"></i></div>
                    </div>
                    <div class="stat-value">${{ total_expense }}</div>
                    <div class="stat-trend neutral">
                        Este mes
                    </div>
                </div>
            </div>

            <!-- Charts Section -->
            <div class="charts-grid">
                <div class="chart-card">
                    <div class="chart-header">
                        <h3>Flujo de caja</h3>
                        <p class="text-muted small mb-0">Comparativa diaria de tus ingresos vs gastos.</p>
                    </div>
                    <div class="chart-scroll-wrapper" style="overflow-x: auto; width: 100%;">
                        <div class="chart-container-inner" id="cashFlowContainer"
                            style="position: relative; height: 300px; width: 100%;">
                            <canvas id="cashFlowChart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="chart-card">
                    <div class="chart-header">
                        <h3>Gastos por categoría</h3>
                        <p class="text-muted small mb-0">Distribución de tus gastos por tipo.</p>
                    </div>
                    <div class="chart-container" style="position: relative; height: 300px; width: 100%;">
                        <canvas id="expensesChart"></canvas>
                    </div>
                </div>
            </div>
            {% else %}
            <!-- Onboarding / Empty State -->
            <div class="onboarding-container text-center pt-0 pb-5 d-flex flex-column align-items-center justify-content-center"
                style="min-height: 85vh; background: radial-gradient(circle at center, rgba(37,99,235,0.03) 0%, transparent 70%);">

                <div class="mb-5 fade-in">
                    <div class="icon-box-xl mx-auto mb-4"
                        style="width: 120px; height: 120px; background: linear-gradient(135deg, var(--bg-color), var(--card-bg)); border-radius: 40px; display:flex; align-items:center; justify-content:center; font-size: 3.5rem; color: var(--primary-color); box-shadow: 0 20px 40px -10px rgba(37,99,235,0.15); border: 1px solid var(--border-color); transform: rotate(-5deg);">
                        <i class="bi bi-wallet2"></i>
                    </div>
                    <h2 class="fw-bolder mb-3 display-5" style="letter-spacing: -1px;">¡Tu viaje financiero comienza
                        hoy!</h2>
                    <p class="text-muted fs-5 mx-auto" style="max-width: 600px; line-height: 1.6;">
                        Bienvenido, <span class="fw-bold text-primary">{{ name }}</span>. Estás a un paso de tomar el
                        control total.
                        Comienza registrando tu primer movimiento para desbloquear el poder de tus estadísticas.
                    </p>
                </div>

                <!-- Features Grid -->
                <div class="row g-4 justify-content-center mb-5 w-100 fade-in"
                    style="max-width: 1100px; animation-delay: 0.2s;">
                    <div class="col-md-4">
                        <div class="card h-100 border-0 shadow-sm p-4 text-start hover-lift"
                            style="border-radius: 28px; background: var(--card-bg); transition: all 0.3s ease;">
                            <div class="mb-4 d-inline-flex p-3 rounded-4"
                                style="background: rgba(37, 99, 235, 0.1); color: var(--primary-color);">
                                <i class="bi bi-receipt-cutoff fs-3"></i>
                            </div>
                            <h4 class="fw-bold mb-2">Registro intuitivo</h4>
                            <p class="text-muted small">Olvídate de hojas de cálculo complicadas. Registra gastos e
                                ingresos en segundos.</p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card h-100 border-0 shadow-sm p-4 text-start hover-lift"
                            style="border-radius: 28px; background: var(--card-bg); transition: all 0.3s ease;">
                            <div class="mb-4 d-inline-flex p-3 rounded-4"
                                style="background: rgba(16, 185, 129, 0.1); color: var(--success-color);">
                                <i class="bi bi-robot fs-3"></i>
                            </div>
                            <h4 class="fw-bold mb-2">Automatización</h4>
                            <p class="text-muted small">Configura tus suscripciones y pagos recurrentes una vez,
                                nosotros nos encargamos del resto.</p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card h-100 border-0 shadow-sm p-4 text-start hover-lift"
                            style="border-radius: 28px; background: var(--card-bg); transition: all 0.3s ease;">
                            <div class="mb-4 d-inline-flex p-3 rounded-4"
                                style="background: rgba(245, 158, 11, 0.1); color: var(--accent-color);">
                                <i class="bi bi-pie-chart-fill fs-3"></i>
                            </div>
                            <h4 class="fw-bold mb-2">Claridad total</h4>
                            <p class="text-muted small">Gráficos interactivos y reportes mensuales que te dicen
                                exactamente a dónde va tu dinero.</p>
                        </div>
                    </div>
                </div>

                <div class="fade-in" style="animation-delay: 0.4s;">
                    <button onclick="showSection('movements')"
                        class="btn btn-primary btn-lg rounded-pill px-5 py-3 shadow-lg fw-bold d-inline-flex align-items-center gap-2 hover-scale">
                        <span>Registrar mi primer movimiento</span>
                        <i class="bi bi-arrow-right"></i>
                    </button>
                    <p class="mt-3 text-muted small">No te preocupes, puedes editarlo o borrarlo después.</p>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Movements Section (Hidden by Default) -->
        <div class="content-body d-none fade-in" id="section-movements">
            <div class="welcome-section mb-4">
                <h2 class="fw-bold mb-1">Movimientos</h2>
                <p class="text-muted">Gestiona tus ingresos, gastos y suscripciones.</p>
            </div>

            <!-- Internal Tabs -->
            <div class="d-flex gap-3 mb-4">
                <button class="btn btn-tab active" id="tab-btn-trans" onclick="switchMovTab('trans')">
                    <i class="bi bi-list-check"></i> Transacciones
                </button>
                <button class="btn btn-tab" id="tab-btn-subs" onclick="switchMovTab('subs')">
                    <i class="bi bi-arrow-repeat"></i> Suscripciones
                </button>
            </div>

            <!-- TRANSACTIONS TAB -->
            <div id="mov-tab-trans" class="fade-in">
                <div class="row">
                    <!-- Form Column -->
                    <div class="col-lg-5 mb-4">
                        <div class="card h-100 border-0 shadow-sm"
                            style="background: var(--card-bg); border-radius: 24px; overflow: hidden;">
                            <div class="card-body p-4">
                                <h4 class="card-title mb-4 fw-bold" style="color: var(--text-main);">Registrar nuevo
                                </h4>

                                <form action="{{ url_for('movements') }}" method="POST">
                                    <!-- Custom Toggle Switch -->
                                    <div class="mb-4">
                                        <label class="form-label text-muted small ms-1">Tipo de movimiento</label>
                                        <div class="transaction-toggle-container">
                                            <input type="radio" name="type" id="t-expense" value="expense" checked
                                                hidden onchange="updateToggle(this)">
                                            <label for="t-expense" class="toggle-option active-expense"
                                                id="label-expense">
                                                <i class="bi bi-arrow-down-circle-fill"></i> Gasto
                                            </label>

                                            <input type="radio" name="type" id="t-income" value="income" hidden
                                                onchange="updateToggle(this)">
                                            <label for="t-income" class="toggle-option" id="label-income">
                                                <i class="bi bi-arrow-up-circle-fill"></i> Ingreso
                                            </label>
                                        </div>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label text-muted small ms-1">Título</label>
                                        <div class="input-group-premium">
                                            <i class="bi bi-tag-fill"></i>
                                            <input type="text" name="title" class="form-control-premium"
                                                placeholder="Ej: Compra semanal" required>
                                        </div>
                                    </div>

                                    <div class="row g-3 mb-3">
                                        <div class="col-6">
                                            <label class="form-label text-muted small ms-1">Monto</label>
                                            <div class="input-group-premium">
                                                <i class="bi bi-currency-dollar"></i>
                                                <input type="number" step="0.01" name="amount"
                                                    class="form-control-premium" placeholder="0.00" required>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <label class="form-label text-muted small ms-1">Categoría</label>
                                            <div class="input-group-premium">
                                                <i class="bi bi-grid-fill"></i>
                                                <select name="category" class="form-control-premium"
                                                    style="cursor: pointer;" required>
                                                    <option value="" disabled selected>Seleccionar</option>
                                                    <option value="Comida">Comida</option>
                                                    <option value="Transporte">Transporte</option>
                                                    <option value="Vivienda">Vivienda</option>
                                                    <option value="Salud">Salud</option>
                                                    <option value="Entretenimiento">Entretenimiento</option>
                                                    <option value="Salario">Salario</option>
                                                    <option value="Otros">Otros</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>

                                    <button type="submit"
                                        class="btn btn-primary btn-premium w-100 py-3 rounded-pill mt-2">
                                        <i class="bi bi-check2-circle me-2"></i> Guardar movimiento
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>

                    <!-- History Column -->
                    <div class="col-lg-7">
                        <div class="card h-100 border-0 shadow-sm"
                            style="background: var(--card-bg); border-radius: 24px;">
                            <div class="card-body p-4">
                                <h4 class="card-title mb-4 fw-bold" style="color: var(--text-main);">Historial reciente
                                </h4>

                                <div class="history-list">
                                    {% for t in transactions %}
                                    <!-- Logic for Icons/Colors -->
                                    {% set icon = 'bi-grid' %}
                                    {% set color = 'cat-bg-gray' %}

                                    {% if t.category == 'Comida' %}
                                    {% set icon = 'bi-basket' %}
                                    {% set color = 'cat-bg-orange' %}
                                    {% elif t.category == 'Transporte' %}
                                    {% set icon = 'bi-car-front' %}
                                    {% set color = 'cat-bg-blue' %}
                                    {% elif t.category == 'Vivienda' %}
                                    {% set icon = 'bi-house-heart' %}
                                    {% set color = 'cat-bg-purple' %}
                                    {% elif t.category == 'Salud' %}
                                    {% set icon = 'bi-heart-pulse' %}
                                    {% set color = 'cat-bg-red' %}
                                    {% elif t.category == 'Entretenimiento' %}
                                    {% set icon = 'bi-music-note-beamed' %}
                                    {% set color = 'cat-bg-pink' %}
                                    {% elif t.category == 'Salario' %}
                                    {% set icon = 'bi-cash-coin' %}
                                    {% set color = 'cat-bg-green' %}
                                    {% endif %}

                                    <div class="history-item">
                                        <div class="history-icon-box {{ color }}">
                                            <i class="bi {{ icon }}"></i>
                                        </div>
                                        <div class="history-details">
                                            <span class="history-title">{{ t.title }}</span>
                                            <div class="history-subtitle">
                                                <span>{{ t.category }}</span>
                                                <i class="bi bi-dot"></i>
                                                <span>{{ t.date.strftime('%d %b') }}</span>
                                            </div>
                                        </div>
                                        <div class="text-end">
                                            <div
                                                class="history-amount {{ 'text-success' if t.type == 'income' else 'text-danger' }}">
                                                {{ '+' if t.type == 'income' else '-' }}${{ "{:,.2f}".format(t.amount)
                                                }}
                                            </div>
                                            <!-- Action Buttons -->
                                            <div class="mt-1">
                                                <button class="btn btn-link p-0 text-muted me-2"
                                                    onclick="openEditModal('{{ t.id }}')"
                                                    style="font-size: 0.9rem; text-decoration: none;">
                                                    <i class="bi bi-pencil"></i>
                                                </button>
                                                <button class="btn btn-link p-0 text-muted"
                                                    onclick="deleteTransaction('{{ t.id }}')"
                                                    style="font-size: 0.9rem; text-decoration: none; color: #ef4444 !important;">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    {% else %}
                                    <div class="empty-state-history">
                                        <i class="bi bi-wallet2 fs-1 mb-3" style="color: var(--border-color);"></i>
                                        <p class="mb-0 fw-medium">No hay movimientos aún</p>
                                        <p class="small text-muted">Registra tu primer ingreso o gasto.</p>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- SUBSCRIPTIONS TAB -->
            <div id="mov-tab-subs" class="d-none fade-in">
                <div class="row g-4">
                    <!-- Add New Column -->
                    <div class="col-lg-4 mb-4">
                        <div class="card h-100 border-0 shadow-sm"
                            style="background: var(--card-bg); border-radius: 24px; text-align:center; border: 2px dashed var(--border-color) !important;">
                            <div class="card-body p-4 d-flex flex-column justify-content-center align-items-center"
                                style="min-height: 250px; cursor: pointer;"
                                onclick="document.getElementById('subscription-modal').style.display='flex'">
                                <div
                                    style="width: 60px; height: 60px; border-radius: 50%; background: var(--bg-color); display:flex; align-items:center; justify-content:center; margin-bottom: 20px;">
                                    <i class="bi bi-plus-lg fs-3 text-primary"></i>
                                </div>
                                <h5 class="fw-bold" style="color: var(--text-main);">Nueva suscripción
                                </h5>
                                <p class="text-muted small">Netflix, Spotify, Renta, etc.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Subscriptions List -->
                    {% if subscriptions %}
                    {% for sub in subscriptions %}
                    <div class="col-lg-4 mb-4">
                        <div class="card h-100 border-0 shadow-sm"
                            style="background: var(--card-bg); border-radius: 24px; position:relative;">
                            <div class="card-body p-4">
                                <div class="d-flex justify-content-between align-items-start mb-3">
                                    <div class="icon-box-sm"
                                        style="width: 50px; height: 50px; border-radius: 16px; background: rgba(37, 99, 235, 0.1); color: #2563eb; display:flex; align-items:center; justify-content:center; font-size: 1.5rem;">
                                        <i class="bi bi-arrow-repeat"></i>
                                    </div>
                                    <button class="btn btn-link text-danger p-0"
                                        onclick="deleteSubscription('{{ sub.id }}')"><i
                                            class="bi bi-trash"></i></button>
                                </div>

                                <h5 class="fw-bold mb-1" style="color: var(--text-main);">{{ sub.name }}
                                </h5>
                                <p class="text-muted small mb-3">{{ sub.category }} • {{
                                    sub.billing_period|capitalize }}</p>

                                <div class="d-flex justify-content-between align-items-end mt-4">
                                    <div>
                                        <small class="d-block text-muted" style="font-size: 0.75rem;">PRÓXIMO
                                            COBRO</small>
                                        <span class="fw-medium" style="color: var(--text-main);">{{
                                            sub.next_due_date.strftime('%d %b %Y') }}</span>
                                    </div>
                                    <div class="text-end">
                                        <small class="d-block text-muted" style="font-size: 0.75rem;">MONTO</small>
                                        <span class="fw-bold fs-5" style="color: var(--text-main);">${{
                                            "{:,.2f}".format(sub.amount) }}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Calendar Section (Hidden by Default) -->
        <!-- Calendar Section (Hidden by Default) -->
        <div class="content-body d-none fade-in" id="section-calendar">
            <div class="welcome-section mb-4">
                <h2 class="fw-bold mb-1">Tu calendario</h2>
                <p class="text-muted">Visualiza tu flujo de dinero mes a mes.</p>
            </div>

            <div class="row g-4 calendar-row">
                <!-- Calendar Grid -->
                <div class="col-lg-8 h-100">
                    <div class="calendar-card">
                        <div class="calendar-controls">
                            <button class="month-nav-btn" id="prevMonth"><i class="bi bi-chevron-left"></i></button>
                            <h3 id="calendarMonthYear">Mes año</h3>
                            <button class="month-nav-btn" id="nextMonth"><i class="bi bi-chevron-right"></i></button>
                        </div>

                        <div class="calendar-grid-header">
                            <span>Dom</span><span>Lun</span><span>Mar</span><span>Mié</span><span>Jue</span><span>Vie</span><span>Sáb</span>
                        </div>

                        <div class="calendar-grid" id="calendarGrid">
                            <!-- Dynamic Days injected by JS -->
                        </div>
                    </div>
                </div>

                <!-- Day Details Panel -->
                <div class="col-lg-4 h-100">
                    <div class="details-card">
                        <!-- Dynamic Header -->
                        <div class="details-header-bg text-center">
                            <div id="selectedDateInfo">
                                <span class="details-day-name">Hoy</span>
                                <span class="details-day-number" id="detailBannerDay">--</span>
                                <span class="details-month-year" id="detailBannerMonth">Selecciona un día</span>
                            </div>
                        </div>

                        <!-- Scrollable List -->
                        <div class="details-body custom-scrollbar">
                            <div id="detailList" class="timeline-container">
                                <!-- Empty State Default -->
                                <div class="details-empty-state">
                                    <i class="bi bi-calendar-event"></i>
                                    <p>Toca un día para ver tus movimientos detallados.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Budgets Section (Hidden by Default) -->
        <div class="content-body d-none fade-in" id="section-budgets">
            <div class="welcome-section mb-4">
                <h2 class="fw-bold mb-1">Presupuestos mensuales</h2>
                <p class="text-muted">Establece límites de gasto para mantener tus finanzas bajo control.</p>
            </div>

            {% if budgets %}
            <div class="row g-4">
                <!-- Add New Budget Card (Always visible in grid) -->
                <div class="col-lg-4 mb-4">
                    <div class="card h-100 border-0 shadow-sm hover-lift"
                        style="background: var(--card-bg); border-radius: 24px; text-align:center; border: 2px dashed var(--border-color) !important; transition: all 0.3s ease;">
                        <div class="card-body p-4 d-flex flex-column justify-content-center align-items-center"
                            style="min-height: 250px; cursor: pointer;"
                            onclick="document.getElementById('add-budget-modal').style.display = 'flex'">
                            <div
                                style="width: 70px; height: 70px; border-radius: 50%; background: linear-gradient(135deg, rgba(37,99,235,0.1), rgba(37,99,235,0.05)); display:flex; align-items:center; justify-content:center; margin-bottom: 20px;">
                                <i class="bi bi-plus-lg fs-2 text-primary"></i>
                            </div>
                            <h5 class="fw-bold" style="color: var(--text-main);">Nuevo presupuesto</h5>
                            <p class="text-muted small">Comida, Transporte, Ocio...</p>
                        </div>
                    </div>
                </div>

                {% for budget in budgets %}
                <div class="col-lg-4 mb-4">
                    <div class="card h-100 border-0 shadow-sm" style="background: var(--card-bg); border-radius: 24px;">
                        <div class="card-body p-4 d-flex flex-column h-100">
                            <div class="d-flex justify-content-between align-items-start mb-4">
                                <div class="icon-box-sm"
                                    style="width: 50px; height: 50px; border-radius: 16px; background: rgba(37,99,235,0.1); color: var(--primary-color); display:flex; align-items:center; justify-content:center; font-size: 1.5rem;">
                                    <i class="bi bi-wallet2"></i>
                                </div>
                                <div class="dropdown">
                                    <button class="btn btn-link text-muted p-0" type="button" data-bs-toggle="dropdown"
                                        aria-expanded="false">
                                        <i class="bi bi-three-dots-vertical"></i>
                                    </button>
                                    <ul class="dropdown-menu dropdown-menu-end border-0 shadow-sm rounded-4">
                                        <li><button class="dropdown-item"
                                                onclick="openEditBudgetModal('{{ budget.id }}', '{{ budget.category }}', '{{ budget.amount }}')"><i
                                                    class="bi bi-pencil me-2"></i>Editar</button></li>
                                        <li>
                                            <hr class="dropdown-divider">
                                        </li>
                                        <li><button class="dropdown-item text-danger"
                                                onclick="deleteBudget('{{ budget.id }}')"><i
                                                    class="bi bi-trash me-2"></i>Eliminar</button></li>
                                    </ul>
                                </div>
                            </div>

                            <h5 class="fw-bold mb-1" style="color: var(--text-main); font-size: 1.25rem;">{{
                                budget.category }}</h5>
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <span class="fw-bold fs-3" style="color: var(--text-main);">${{
                                    "{:,.2f}".format(budget.spent) }}</span>
                                <span class="text-muted small">Límite: ${{ "{:,.0f}".format(budget.amount) }}</span>
                            </div>

                            <div class="mt-auto">
                                <div class="progress mb-2"
                                    style="height: 10px; border-radius: 10px; background: var(--bg-color);">
                                    <div class="progress-bar bg-{{ budget.status_color }}" role="progressbar"
                                        style="--budget-width: {{ budget.percentage }}%; width: var(--budget-width); border-radius: 10px;"
                                        aria-valuenow="{{ budget.percentage }}" aria-valuemin="0" aria-valuemax="100">
                                    </div>
                                </div>

                                <div class="d-flex justify-content-between align-items-center">
                                    <small class="text-{{ budget.status_color }} fw-bold">
                                        {{ budget.percentage }}% usado
                                    </small>
                                    <small class="text-muted">
                                        Restante: ${{ "{:,.2f}".format(budget.remaining) }}
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <!-- Empty State Tutorial (Savings Goals Design) -->
            <!-- Tutorial / Empty State -->
            <div class="card border-0 shadow-sm"
                style="background: var(--card-bg); border-radius: 24px; overflow: hidden;">
                <div class="card-body p-5 text-center">
                    <div class="mb-4">
                        <div
                            style="width: 80px; height: 80px; background: rgba(37,99,235,0.1); border-radius: 50%; display: inline-flex; align-items: center; justify-content: center;">
                            <i class="bi bi-wallet2 text-primary fs-1"></i>
                        </div>
                    </div>
                    <h3 class="fw-bold mb-3" style="color: var(--text-main);">Toma el control de tus gastos</h3>
                    <p class="text-muted mb-5" style="max-width: 600px; margin: 0 auto;">
                        Los presupuestos te ayudan a no gastar de más en lo que importa.
                    </p>

                    <div class="row g-4 justify-content-center mb-5">
                        <div class="col-md-4">
                            <div class="p-3">
                                <i class="bi bi-tag-fill fs-2 text-primary mb-3 d-block"></i>
                                <h5 class="fw-bold" style="color: var(--text-main);">1. Elige categoría</h5>
                                <p class="text-muted small">Selecciona una categoría clave como "Comida" o "Transporte".
                                </p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="p-3">
                                <i class="bi bi-cone-striped fs-2 text-warning mb-3 d-block"></i>
                                <h5 class="fw-bold" style="color: var(--text-main);">2. Pon un límite</h5>
                                <p class="text-muted small">Define cuánto quieres gastar máximo al mes en esa área.</p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="p-3">
                                <i class="bi bi-bell-fill fs-2 text-danger mb-3 d-block"></i>
                                <h5 class="fw-bold" style="color: var(--text-main);">3. Recibe alertas</h5>
                                <p class="text-muted small">Te avisaremos cuando te acerques a tu límite para que
                                    frenes.</p>
                            </div>
                        </div>
                    </div>

                    <button class="btn btn-primary btn-premium rounded-pill px-5 py-3 fw-bold"
                        onclick="document.getElementById('add-budget-modal').style.display = 'flex'">
                        <i class="bi bi-plus-lg me-2"></i> Crear primer presupuesto
                    </button>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Reports Section (Hidden by Default) -->
        <!-- Reports Section (Hidden by Default) -->
        <div class="content-body d-none fade-in" id="section-reports">
            <div class="welcome-section mb-4">
                <h2 class="fw-bold mb-1">Informes y estadísticas</h2>
                <p class="text-muted">Analiza la salud de tus finanzas a largo plazo.</p>
            </div>

            <div class="row g-4 mb-4">
                <!-- Current Month Summary -->
                <div class="col-lg-12">
                    <div class="card border-0 shadow-sm"
                        style="background: var(--card-bg); border-radius: 24px; overflow: hidden;">
                        <div class="card-body p-4">
                            <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap">
                                <div>
                                    <h4 class="mb-1 fw-bold" style="color: var(--text-main);">Resumen de {{ report_month
                                        }}</h4>
                                    <div class="d-flex align-items-center gap-2">
                                        <span class="badge"
                                            style="background: rgba(16, 185, 129, 0.1); color: #10b981;">
                                            <i class="bi bi-circle-fill"
                                                style="font-size: 6px; vertical-align: middle;"></i> En curso
                                        </span>
                                        <small class="text-muted">Se actualiza en tiempo real</small>
                                    </div>
                                </div>

                                <a href="{{ url_for('download_report') }}" onclick="showReportLoader()"
                                    class="btn btn-primary btn-premium rounded-pill px-4">
                                    <i class="bi bi-file-earmark-pdf-fill me-2"></i> Descargar reporte
                                </a>
                            </div>

                            <div class="row g-4">
                                <!-- KPI 1: Savings Rate -->
                                <div class="col-md-4">
                                    <div class="report-kpi-card p-4 rounded-4 h-100 position-relative"
                                        style="background: linear-gradient(135deg, rgba(37, 99, 235, 0.05), rgba(37, 99, 235, 0.01)); border: 1px solid rgba(37, 99, 235, 0.1);">
                                        <button class="btn btn-sm btn-link position-absolute top-0 end-0 m-2 text-muted"
                                            onclick="openHelpModal('savings')" style="z-index: 10;">
                                            <i class="bi bi-question-circle"></i>
                                        </button>
                                        <div class="d-flex align-items-center mb-3">
                                            <div class="icon-box-sm bg-blue-light text-blue me-3"
                                                style="width: 40px; height: 40px; border-radius: 12px; display:flex; align-items:center; justify-content:center; background: rgba(37,99,235,0.1); color: #2563eb;">
                                                <i class="bi bi-piggy-bank-fill fs-5"></i>
                                            </div>
                                            <span class="text-muted fw-medium">Tasa de ahorro</span>
                                        </div>
                                        <h2 class="fw-bold text-blue mb-1" style="color: #2563eb;">{{ savings_rate }}%
                                        </h2>
                                        <p class="mb-0 small text-muted">De tus ingresos totales</p>
                                    </div>
                                </div>

                                <!-- KPI 2: Top Category -->
                                <div class="col-md-4">
                                    <div class="report-kpi-card p-4 rounded-4 h-100 position-relative"
                                        style="background: linear-gradient(135deg, rgba(245, 158, 11, 0.05), rgba(245, 158, 11, 0.01)); border: 1px solid rgba(245, 158, 11, 0.1);">
                                        <button class="btn btn-sm btn-link position-absolute top-0 end-0 m-2 text-muted"
                                            onclick="openHelpModal('category')" style="z-index: 10;">
                                            <i class="bi bi-question-circle"></i>
                                        </button>
                                        <div class="d-flex align-items-center mb-3">
                                            <div class="icon-box-sm bg-orange-light text-orange me-3"
                                                style="width: 40px; height: 40px; border-radius: 12px; display:flex; align-items:center; justify-content:center; background: rgba(245, 158, 11, 0.1); color: #f59e0b;">
                                                <i class="bi bi-graph-up-arrow fs-5"></i>
                                            </div>
                                            <span class="text-muted fw-medium">Mayor gasto en</span>
                                        </div>
                                        <h2 class="fw-bold text-orange mb-1 text-truncate" style="color: #f59e0b;">{{
                                            top_category }}</h2>
                                        <p class="mb-0 small text-muted">{{ top_cat_percentage }}% del total de gastos
                                        </p>
                                    </div>
                                </div>

                                <!-- KPI 3: Surplus Days -->
                                <div class="col-md-4">
                                    <div class="report-kpi-card p-4 rounded-4 h-100 position-relative"
                                        style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.05), rgba(16, 185, 129, 0.01)); border: 1px solid rgba(16, 185, 129, 0.1);">
                                        <button class="btn btn-sm btn-link position-absolute top-0 end-0 m-2 text-muted"
                                            onclick="openHelpModal('surplus')" style="z-index: 10;">
                                            <i class="bi bi-question-circle"></i>
                                        </button>
                                        <div class="d-flex align-items-center mb-3">
                                            <div class="icon-box-sm bg-green-light text-green me-3"
                                                style="width: 40px; height: 40px; border-radius: 12px; display:flex; align-items:center; justify-content:center; background: rgba(16, 185, 129, 0.1); color: #10b981;">
                                                <i class="bi bi-calendar-check-fill fs-5"></i>
                                            </div>
                                            <span class="text-muted fw-medium">Días positivos</span>
                                        </div>
                                        <h2 class="fw-bold text-green mb-1" style="color: #10b981;">{{ surplus_days }}
                                        </h2>
                                        <p class="mb-0 small text-muted">De {{ total_days_month }} días del mes</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- History Section -->
            <div class="row">
                <div class="col-12">
                    <div class="card border-0 shadow-sm" style="background: var(--card-bg); border-radius: 24px;">
                        <div class="card-body p-4">
                            <h4 class="card-title mb-4 fw-bold" style="color: var(--text-main);">Historial de periodos
                            </h4>

                            <div class="report-list">
                                {% if monthly_history %}
                                {% for report in monthly_history %}
                                <div class="report-item p-3 mb-3 rounded-4 d-flex align-items-center justify-content-between flex-wrap gap-3"
                                    style="background: var(--bg-color); border: 1px solid transparent; transition: all 0.2s;">
                                    <div class="d-flex align-items-center">
                                        <div class="report-icon me-3"
                                            style="width: 50px; height: 50px; border-radius: 16px; background: rgba(139, 92, 246, 0.1); color: #8b5cf6; display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">
                                            <i class="bi bi-file-earmark-text"></i>
                                        </div>
                                        <div>
                                            <h5 class="mb-0 fw-bold" style="color: var(--text-main);">{{ report.name }}
                                            </h5>
                                            <small class="text-muted">Reporte mensual cerrado</small>
                                        </div>
                                    </div>

                                    <div class="d-flex gap-4 text-end report-stats mobile-hide">
                                        <div>
                                            <small class="d-block text-muted"
                                                style="font-size: 0.75rem;">INGRESOS</small>
                                            <span class="fw-bold text-success">+${{
                                                "{:,.2f}".format(report.total_income) }}</span>
                                        </div>
                                        <div>
                                            <small class="d-block text-muted" style="font-size: 0.75rem;">GASTOS</small>
                                            <span class="fw-bold text-danger">-${{
                                                "{:,.2f}".format(report.total_expense) }}</span>
                                        </div>
                                        <div>
                                            <small class="d-block text-muted"
                                                style="font-size: 0.75rem;">BALANCE</small>
                                            <span class="fw-bold" style="color: var(--text-main);">{{ '+' if
                                                report.balance >= 0 else '' }}${{ "{:,.2f}".format(report.balance)
                                                }}</span>
                                        </div>
                                    </div>


                                    <div class="report-actions">
                                        <a href="{{ url_for('download_report', month=report.month, year=report.year) }}"
                                            onclick="showReportLoader()"
                                            class="btn btn-outline-secondary rounded-pill btn-sm px-3"
                                            style="border-color: var(--border-color); color: var(--text-secondary);">
                                            <i class="bi bi-download me-1"></i> PDF
                                        </a>
                                    </div>
                                </div>
                                {% endfor %}
                                {% else %}
                                <div class="text-center py-5">
                                    <i class="bi bi-folder2-open fs-1 text-muted opacity-50 mb-3 d-block"></i>
                                    <p class="text-muted">Aún no tienes historiales generados.</p>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Budgets Section (Hidden by Default) -->




        <!-- Goals Section (Hidden by Default) -->
        <div class="content-body d-none fade-in" id="section-goals">
            <div class="welcome-section mb-4">
                <h2 class="fw-bold mb-1">Metas de ahorro</h2>
                <p class="text-muted">Enfócate en acumular riqueza y cumplir tus sueños.</p>
            </div>

            {% if not savings_goals %}
            <!-- Tutorial / Empty State -->
            <div class="card border-0 shadow-sm"
                style="background: var(--card-bg); border-radius: 24px; overflow: hidden;">
                <div class="card-body p-5 text-center">
                    <div class="mb-4">
                        <div
                            style="width: 80px; height: 80px; background: rgba(37,99,235,0.1); border-radius: 50%; display: inline-flex; align-items: center; justify-content: center;">
                            <i class="bi bi-stars text-primary fs-1"></i>
                        </div>
                    </div>
                    <h3 class="fw-bold mb-3" style="color: var(--text-main);">¿Cómo funcionan las metas?</h3>
                    <p class="text-muted mb-5" style="max-width: 600px; margin: 0 auto;">
                        Alcanza tus objetivos financieros sin estrés. FinanzApp divide tu meta en pequeños pasos
                        mensuales.
                    </p>

                    <div class="row g-4 justify-content-center mb-5">
                        <div class="col-md-4">
                            <div class="p-3">
                                <i class="bi bi-geo-alt-fill fs-2 text-warning mb-3 d-block"></i>
                                <h5 class="fw-bold" style="color: var(--text-main);">1. Define tu destino</h5>
                                <p class="text-muted small">Elige un nombre para tu meta (ej. "Viaje a Europa") y
                                    visualízalo.</p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="p-3">
                                <i class="bi bi-calendar-check-fill fs-2 text-success mb-3 d-block"></i>
                                <h5 class="fw-bold" style="color: var(--text-main);">2. Pon una fecha</h5>
                                <p class="text-muted small">Establece una fecha límite realista para cumplirlo.</p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="p-3">
                                <i class="bi bi-piggy-bank-fill fs-2 text-danger mb-3 d-block"></i>
                                <h5 class="fw-bold" style="color: var(--text-main);">3. Ahorra mes a mes</h5>
                                <p class="text-muted small">Te diremos cuánto necesitas guardar mensualmente para
                                    lograrlo.</p>
                            </div>
                        </div>
                    </div>

                    <button class="btn btn-primary btn-premium rounded-pill px-5 py-3 fw-bold"
                        onclick="openGoalModal()">
                        <i class="bi bi-plus-lg me-2"></i> Crear mi primera meta
                    </button>
                </div>
            </div>
            {% else %}
            <!-- Grid Layout -->
            <div class="row g-4">
                <!-- Add New Goal Card -->
                <div class="col-lg-4 mb-4">
                    <div class="card h-100 border-0 shadow-sm hover-lift"
                        style="background: var(--card-bg); border-radius: 24px; text-align:center; border: 2px dashed var(--border-color) !important; transition: all 0.3s ease;">
                        <div class="card-body p-4 d-flex flex-column justify-content-center align-items-center"
                            style="min-height: 250px; cursor: pointer;" onclick="openGoalModal()">
                            <div
                                style="width: 70px; height: 70px; border-radius: 50%; background: linear-gradient(135deg, rgba(37,99,235,0.1), rgba(37,99,235,0.05)); display:flex; align-items:center; justify-content:center; margin-bottom: 20px;">
                                <i class="bi bi-plus-lg fs-2 text-primary"></i>
                            </div>
                            <h5 class="fw-bold" style="color: var(--text-main);">Nueva meta</h5>
                            <p class="text-muted small">Viaje, Coche, Fondo de emergencia...</p>
                        </div>
                    </div>
                </div>

                {% for goal in savings_goals %}
                <div class="col-lg-4 mb-4">
                    <div class="card h-100 border-0 shadow-sm position-relative"
                        style="background: var(--card-bg); border-radius: 24px; overflow:hidden;">
                        <!-- Delete Button -->
                        <button class="btn btn-link position-absolute top-0 end-0 m-3 text-muted p-0"
                            onclick="deleteGoal('{{ goal.id }}')" style="z-index: 5;">
                            <i class="bi bi-trash"></i>
                        </button>

                        <div class="card-body p-4 d-flex flex-column h-100">
                            <div class="d-flex align-items-center mb-4">
                                <div class="icon-box-sm me-3"
                                    style="width: 50px; height: 50px; border-radius: 16px; background: rgba(16, 185, 129, 0.1); color: #10b981; display:flex; align-items:center; justify-content:center; font-size: 1.5rem;">
                                    <i class="bi bi-trophy-fill"></i>
                                </div>
                                <div>
                                    <h5 class="fw-bold mb-0 text-truncate"
                                        style="color: var(--text-main); max-width: 230px;">{{ goal.name }}</h5>
                                    <small class="text-muted">Objetivo: {{ goal.target_date }}</small>
                                </div>
                            </div>
                            <!-- Feasibility Badge Mobile/Desktop Friendly -->
                            {% if goal.remaining_amount > 0 and not goal.is_past_due %}
                            <div class="position-absolute" style="top: 1rem; right: 3.5rem;">
                                <span
                                    class="badge bg-{{ goal.feasibility_color }} bg-opacity-10 text-{{ goal.feasibility_color }} rounded-pill px-2 py-1 small border border-{{ goal.feasibility_color }} border-opacity-10"
                                    style="font-size: 0.7rem;">
                                    <i class="bi bi-activity me-1"></i> {{ goal.feasibility | capitalize }}
                                </span>
                            </div>
                            {% endif %}

                            <div class="mb-4">
                                <div class="d-flex justify-content-between text-muted small mb-2">
                                    <span>Progreso</span>
                                    <span class="fw-bold text-primary">{{ goal.progress }}%</span>
                                </div>
                                <div class="progress"
                                    style="height: 10px; border-radius: 10px; background-color: var(--bg-color);">
                                    <div class="progress-bar bg-primary" role="progressbar"
                                        style="--goal-width: {{ goal.progress }}%; width: var(--goal-width); border-radius: 10px;"
                                        aria-valuenow="{{ goal.progress }}" aria-valuemin="0" aria-valuemax="100"></div>
                                </div>
                            </div>

                            <div class="row g-2 mb-4">
                                <div class="col-6">
                                    <small class="d-block text-muted" style="font-size: 0.7rem;">ACUMULADO</small>
                                    <span class="fw-bold text-success fs-5">${{ "{:,.2f}".format(goal.current_amount)
                                        }}</span>
                                </div>
                                <div class="col-6 text-end">
                                    <small class="d-block text-muted" style="font-size: 0.7rem;">META</small>
                                    <span class="fw-bold text-muted fs-6">${{ "{:,.2f}".format(goal.target_amount)
                                        }}</span>
                                </div>
                            </div>

                            <!-- Logic for Alert Message based on Date -->
                            {% if goal.remaining_amount <= 0 %} <div
                                class="alert alert-success border-0 mb-4 p-3 rounded-3">
                                <div class="d-flex align-items-center gap-2">
                                    <i class="bi bi-check-circle-fill"></i>
                                    <small class="fw-bold">¡Meta completada! Felicidades.</small>
                                </div>
                        </div>
                        <div class="mt-auto">
                            <button class="btn btn-outline-success w-100 rounded-pill fw-bold" disabled>
                                <i class="bi bi-star-fill me-2"></i> Completado
                            </button>
                        </div>
                        {% elif goal.is_past_due %}
                        <div class="alert alert-danger border-0 mb-4 p-3 rounded-3">
                            <div class="d-flex align-items-center gap-2">
                                <i class="bi bi-exclamation-triangle-fill"></i>
                                <small class="fw-bold">La fecha objetivo ya pasó.</small>
                            </div>
                        </div>
                        <div class="mt-auto d-flex gap-2">
                            <button class="btn btn-outline-danger w-50 rounded-pill fw-bold btn-sm"
                                onclick="extendGoal('{{ goal.id }}')">
                                <i class="bi bi-calendar-plus me-1"></i> +30 días
                            </button>
                            <button class="btn btn-outline-primary w-50 rounded-pill fw-bold btn-sm"
                                onclick="openAddFundsModal('{{ goal.id }}', '{{ goal.name }}', '{{ goal.remaining_amount }}')">
                                <i class="bi bi-coin me-1"></i> Completar
                            </button>
                        </div>
                        {% elif goal.is_due_today %}
                        <div class="alert alert-warning border-0 mb-4 p-3 rounded-3">
                            <div class="d-flex align-items-center gap-2">
                                <i class="bi bi-alarm-fill"></i>
                                <small class="fw-bold">¡La meta es hoy! ¿Lo lograste?</small>
                            </div>
                        </div>
                        <div class="mt-auto d-flex gap-2">
                            <button class="btn btn-outline-secondary w-50 rounded-pill fw-bold btn-sm"
                                onclick="extendGoal('{{ goal.id }}')">
                                <i class="bi bi-hourglass-split me-1"></i> Posponer
                            </button>
                            <button class="btn btn-primary w-50 rounded-pill fw-bold btn-sm"
                                onclick="openAddFundsModal('{{ goal.id }}', '{{ goal.name }}', '{{ goal.remaining_amount }}')">
                                <i class="bi bi-check2-circle me-1"></i> ¡Sí, pagar!
                            </button>
                        </div>
                        {% else %}
                        <div class="alert alert-light border-0 mb-4 p-3 rounded-3"
                            style="background-color: var(--bg-color);">
                            <div class="d-flex align-items-start gap-3">
                                <div class="mt-1"><i class="bi bi-graph-up-arrow text-primary"></i></div>
                                <div class="w-100">
                                    <small class="text-muted fw-bold d-block mb-2">Esfuerzo sugerido (Smart
                                        Pacing):</small>

                                    <div class="d-flex justify-content-between align-items-end mb-2">
                                        <div>
                                            <span class="fw-bold fs-5 text-primary">${{
                                                "{:,.2f}".format(goal.daily_contribution) }}</span>
                                            <small class="text-muted">/día</small>
                                        </div>
                                        <div class="text-end">
                                            <span class="fw-bold fs-6" style="color: var(--text-main);">${{
                                                "{:,.2f}".format(goal.weekly_contribution) }}</span>
                                            <small class="text-muted">/sem</small>
                                        </div>
                                    </div>

                                    <div class="pt-2 border-top border-secondary-subtle">
                                        <small class="d-block text-{{ goal.feasibility_color }}"
                                            style="font-size: 0.75rem; line-height: 1.2;">
                                            <i class="bi bi-info-circle me-1"></i> {{ goal.feasibility_msg }}
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="mt-auto">
                            <button class="btn btn-outline-primary w-100 rounded-pill fw-bold"
                                onclick="openAddFundsModal('{{ goal.id }}', '{{ goal.name }}')">
                                <i class="bi bi-coin me-2"></i> Abonar
                            </button>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% endif %}
    </div>

    <!-- AI Assistant Section -->
    <!-- AI Assistant Section -->
    <!-- AI Assistant Section -->
    <div class="content-body d-none fade-in" id="section-ai-assistant">
        <div class="welcome-section mb-4 d-flex align-items-center justify-content-between">
            <div>
                <h2 class="fw-bold mb-1 text-main">Aurelius AI</h2>
                <p class="text-muted mb-0">Tu consultor estratégico de inversiones y ahorro.</p>
            </div>
            <div class="d-none d-md-block">
                <span class="badge bg-light text-dark border px-3 py-2 rounded-pill"><i
                        class="bi bi-circle-fill text-success small me-2"></i>Aurelius Online</span>
            </div>
        </div>

        <div class="row g-4 justify-content-center">
            <!-- LEFT COLUMN: VERTICAL INSIGHTS -->
            <div class="col-lg-5 col-xl-4 px-0 px-lg-3">
                <div class="card h-100 border-0 shadow-sm" style="background: transparent;">
                    <div id="insights-container" class="insights-container-wrapper"
                        style="height: calc(100vh - 200px); max-height: 700px; position: relative; mask-image: linear-gradient(to bottom, transparent, black 10%, black 90%, transparent); -webkit-mask-image: linear-gradient(to bottom, transparent, black 10%, black 90%, transparent); overflow: hidden;">

                        <!-- Track -->
                        <div id="insights-track" class="insights-track">

                            {% set daily_avg = current_month_expenses / current_day if current_day > 0 else 0 %}
                            {% set projected = daily_avg * days_in_month %}
                            {% set savings = current_month_income - current_month_expenses %}
                            {% set savings_rate = (savings / current_month_income * 100) if current_month_income > 0
                            else 0 %}



                            <!-- CARDS SET 1 -->
                            <div class="insight-pack d-flex flex-column gap-3">
                                <div class="insight-card-glass p-4">
                                    <div class="d-flex justify-content-between align-items-start mb-3">
                                        <div class="icon-box-glass text-primary"><i class="bi bi-heart-pulse-fill"></i>
                                        </div>
                                        <button class="btn btn-sm btn-icon-only text-muted small"
                                            onclick="showInsightModal('salud')"><i
                                                class="bi bi-info-circle"></i></button>
                                    </div>
                                    <h6 class="fw-bold text-muted small mb-2">Salud financiera</h6>
                                    <h4 class="fw-bold mb-1">{{ "Óptima" if savings_rate > 20 else ("Estable" if
                                        savings_rate > 0 else "Crítica") }}</h4>
                                    <p class="mb-0 text-muted small">Tu tasa de ahorro es del <span
                                            class="text-primary fw-bold">{{ "{:.1f}".format(savings_rate) }}%</span>.
                                    </p>
                                </div>

                                <div class="insight-card-glass p-4">
                                    <div class="d-flex justify-content-between align-items-start mb-3">
                                        <div class="icon-box-glass text-info"><i class="bi bi-calendar-check-fill"></i>
                                        </div>
                                        <button class="btn btn-sm btn-icon-only text-muted small"
                                            onclick="showInsightModal('proyeccion')"><i
                                                class="bi bi-info-circle"></i></button>
                                    </div>
                                    <h6 class="fw-bold text-muted small mb-2">Proyección mensual</h6>
                                    <h4 class="fw-bold mb-1">${{ "{:,.0f}".format(projected) }}</h4>
                                    <p class="mb-0 text-muted small">Gasto estimado al cierre de mes.</p>
                                </div>

                                <div class="insight-card-glass p-4">
                                    <div class="d-flex justify-content-between align-items-start mb-3">
                                        <div class="icon-box-glass text-warning"><i
                                                class="bi bi-lightning-charge-fill"></i></div>
                                        <button class="btn btn-sm btn-icon-only text-muted small"
                                            onclick="showInsightModal('ritmo')"><i
                                                class="bi bi-info-circle"></i></button>
                                    </div>
                                    <h6 class="fw-bold text-muted small mb-2">Gasto diario promedio</h6>
                                    <h4 class="fw-bold mb-1">${{ "{:,.0f}".format(daily_avg) }}</h4>
                                    <p class="mb-0 text-muted small">Gasto promedio por día.</p>
                                </div>

                                <div class="insight-card-glass p-4">
                                    <div class="d-flex justify-content-between align-items-start mb-3">
                                        <div class="icon-box-glass text-danger"><i class="bi bi-pie-chart-fill"></i>
                                        </div>
                                        <button class="btn btn-sm btn-icon-only text-muted small"
                                            onclick="showInsightModal('fuga')"><i
                                                class="bi bi-info-circle"></i></button>
                                    </div>
                                    <h6 class="fw-bold text-muted small mb-2">Fuga de capital</h6>
                                    <h4 class="fw-bold mb-1 text-truncate">{{ top_category }}</h4>
                                    <p class="mb-0 text-muted small">{{ top_cat_percentage }}% de tus gastos van aquí.
                                    </p>
                                </div>

                                <div class="insight-card-glass p-4">
                                    <div class="d-flex justify-content-between align-items-start mb-3">
                                        <div class="icon-box-glass text-secondary"><i
                                                class="bi bi-collection-play-fill"></i></div>
                                        <button class="btn btn-sm btn-icon-only text-muted small"
                                            onclick="showInsightModal('fijos')"><i
                                                class="bi bi-info-circle"></i></button>
                                    </div>
                                    <h6 class="fw-bold text-muted small mb-2">Gastos fijos</h6>
                                    <h4 class="fw-bold mb-1">${{ "{:,.0f}".format(subscriptions_total) }}</h4>
                                    <p class="mb-0 text-muted small">En {{ subscriptions|length }} suscripciones
                                        mensuales.</p>
                                </div>

                                <div class="insight-card-glass p-4">
                                    <div class="d-flex justify-content-between align-items-start mb-3">
                                        <div class="icon-box-glass text-success"><i class="bi bi-trophy-fill"></i></div>
                                        <button class="btn btn-sm btn-icon-only text-muted small"
                                            onclick="showInsightModal('metas')"><i
                                                class="bi bi-info-circle"></i></button>
                                    </div>
                                    <h6 class="fw-bold text-muted small mb-2">Progreso de metas</h6>
                                    <h4 class="fw-bold mb-1">{{ "{:.0f}".format(goals_global_progress) }}%</h4>
                                    <p class="mb-0 text-muted small">Progreso global de ahorro.</p>
                                </div>
                            </div>

                            <!-- CARDS SET 2 (Clone for Infinite Scroll) -->
                            <div class="insight-pack d-flex flex-column gap-3">
                                <div class="insight-card-glass p-4">
                                    <div class="d-flex justify-content-between align-items-start mb-3">
                                        <div class="icon-box-glass text-primary"><i class="bi bi-heart-pulse-fill"></i>
                                        </div>
                                        <button class="btn btn-sm btn-icon-only text-muted small"
                                            onclick="showInsightModal('salud')"><i
                                                class="bi bi-info-circle"></i></button>
                                    </div>
                                    <h4 class="fw-bold mb-1">{{ "Óptima" if savings_rate > 20 else ("Estable" if
                                        savings_rate > 0 else "Crítica") }}</h4>
                                    <p class="mb-0 text-muted small">Tu tasa de ahorro es del <span
                                            class="text-primary fw-bold">{{ "{:.1f}".format(savings_rate) }}%</span>.
                                    </p>
                                </div>

                                <div class="insight-card-glass p-4">
                                    <div class="d-flex justify-content-between align-items-start mb-3">
                                        <div class="icon-box-glass text-info"><i class="bi bi-calendar-check-fill"></i>
                                        </div>
                                        <button class="btn btn-sm btn-icon-only text-muted small"
                                            onclick="showInsightModal('proyeccion')"><i
                                                class="bi bi-info-circle"></i></button>
                                    </div>
                                    <h4 class="fw-bold mb-1">${{ "{:,.0f}".format(projected) }}</h4>
                                    <p class="mb-0 text-muted small">Gasto estimado al cierre de mes.</p>
                                </div>

                                <div class="insight-card-glass p-4">
                                    <div class="d-flex justify-content-between align-items-start mb-3">
                                        <div class="icon-box-glass text-warning"><i
                                                class="bi bi-lightning-charge-fill"></i></div>
                                        <button class="btn btn-sm btn-icon-only text-muted small"
                                            onclick="showInsightModal('proyeccion')"><i
                                                class="bi bi-info-circle"></i></button>
                                    </div>
                                    <h4 class="fw-bold mb-1">${{ "{:,.0f}".format(daily_avg) }}</h4>
                                    <p class="mb-0 text-muted small">Gasto promedio por día.</p>
                                </div>

                                <div class="insight-card-glass p-4">
                                    <div class="d-flex justify-content-between align-items-start mb-3">
                                        <div class="icon-box-glass text-danger"><i class="bi bi-pie-chart-fill"></i>
                                        </div>
                                        <button class="btn btn-sm btn-icon-only text-muted small"
                                            onclick="showInsightModal('proyeccion')"><i
                                                class="bi bi-info-circle"></i></button>
                                    </div>
                                    <h4 class="fw-bold mb-1 text-truncate">{{ top_category }}</h4>
                                    <p class="mb-0 text-muted small">{{ top_cat_percentage }}% de tus gastos van aquí.
                                    </p>
                                </div>

                                <div class="insight-card-glass p-4">
                                    <div class="d-flex justify-content-between align-items-start mb-3">
                                        <div class="icon-box-glass text-secondary"><i
                                                class="bi bi-collection-play-fill"></i></div>
                                        <button class="btn btn-sm btn-icon-only text-muted small"
                                            onclick="showInsightModal('presupuesto')"><i
                                                class="bi bi-info-circle"></i></button>
                                    </div>
                                    <h4 class="fw-bold mb-1">${{ "{:,.0f}".format(subscriptions_total) }}</h4>
                                    <p class="mb-0 text-muted small">En {{ subscriptions|length }} suscripciones
                                        mensuales.</p>
                                </div>

                                <div class="insight-card-glass p-4">
                                    <div class="d-flex justify-content-between align-items-start mb-3">
                                        <div class="icon-box-glass text-success"><i class="bi bi-trophy-fill"></i></div>
                                        <button class="btn btn-sm btn-icon-only text-muted small"
                                            onclick="showInsightModal('metas')"><i
                                                class="bi bi-info-circle"></i></button>
                                    </div>
                                    <h4 class="fw-bold mb-1">{{ "{:.0f}".format(goals_global_progress) }}%</h4>
                                    <p class="mb-0 text-muted small">Progreso global de ahorro.</p>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
            </div>

            <!-- RIGHT COLUMN: AURELIUS CHATBOT -->
            <div class="col-lg-7 col-xl-8">
                <div class="card h-100 border-0 shadow-sm"
                    style="background: var(--card-bg); border-radius: 24px; height: calc(100vh - 200px); max-height: 700px; display: flex; flex-direction: column;">

                    <!-- Chat Header -->
                    <div class="chat-header p-4 border-bottom d-flex align-items-center justify-content-between"
                        style="border-color: rgba(0,0,0,0.05) !important;">
                        <div class="d-flex align-items-center gap-3">
                            <div class="position-relative">
                                <div class="aurelius-avatar d-flex align-items-center justify-content-center bg-gradient-primary text-white shadow-sm"
                                    style="background: linear-gradient(135deg, #4f46e5 0%, #3b82f6 100%);">
                                    <i class="bi bi-robot fs-4"></i>
                                </div>
                                <span
                                    class="position-absolute bottom-0 end-0 p-1 border border-light rounded-circle bg-success"></span>
                            </div>
                            <div>
                                <h4 class="fw-bold mb-0 text-main">Aurelius</h4>
                                <small class="text-muted">Experto Financiero IA &bull; <span class="text-success">En
                                        línea</span></small>
                            </div>
                        </div>
                        <button class="btn btn-light rounded-circle shadow-sm" onclick="clearChat()"
                            title="Borrar conversación">
                            <i class="bi bi-eraser"></i>
                        </button>
                    </div>

                    <!-- Chat Body -->
                    <div id="chat-body" class="chat-body p-4 flex-grow-1 custom-scrollbar"
                        style="overflow-y: auto; background: radial-gradient(circle at top right, rgba(37,99,235,0.02), transparent);">

                        <!-- Initial Message -->
                        <div class="message bot-message fade-in">
                            <div class="message-content">
                                <p class="mb-1">¡Hola, <strong>{{ name }}</strong>! Soy Aurelius, tu asesor financiero
                                    personal.</p>
                                <p class="mb-0">Tengo acceso a todos tus registros financieros. Pregúntame sobre tu
                                    balance, gastos, metas de ahorro o pídeme un consejo.</p>
                            </div>
                            <small class="message-time">Ahora mismo</small>
                        </div>

                        <!-- Quick Prompts (clickable) -->
                        <div class="quick-prompts mt-3 fade-in" id="quick-prompts">
                            <p class="small text-muted mb-2 ms-1">Sugerencias de consulta:</p>
                            <div class="d-flex flex-wrap gap-2">
                                <button class="btn btn-sm btn-outline-primary rounded-pill px-3"
                                    onclick="sendPrompt('Hazme un resumen financiero de hoy')">Resumen rápido</button>
                                <button class="btn btn-sm btn-outline-primary rounded-pill px-3"
                                    onclick="sendPrompt('¿Puedo gastar $500 pesos ahora?')">¿Puedo gastar $$?</button>
                                <button class="btn btn-sm btn-outline-primary rounded-pill px-3"
                                    onclick="sendPrompt('¿Cómo puedo mejorar mi ahorro este mes?')">Mejorar
                                    ahorro</button>
                                <button class="btn btn-sm btn-outline-primary rounded-pill px-3"
                                    onclick="sendPrompt('¿Cuál es mi mayor gasto hormiga?')">Detectar fuga</button>
                            </div>
                        </div>

                    </div>

                    <!-- Chat Input -->
                    <div class="chat-input-area p-3 m-3 mt-0 rounded-4" style="background: var(--bg-color);">
                        <form id="chat-form" onsubmit="handleChatSubmit(event)" class="d-flex gap-2"
                            data-no-loading="true">
                            <input type="text" id="user-input" class="form-control border-0 bg-transparent shadow-none"
                                placeholder="Escribe tu consulta financiera..." autocomplete="off">
                            <button type="submit" id="send-btn" class="btn btn-primary btn-premium rounded-circle"
                                style="width: 45px; height: 45px; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease;">
                                <i class="bi bi-send-fill" id="send-icon"></i>
                                <div class="loader-dots d-none" id="send-spinner">
                                    <div class="dot"></div>
                                    <div class="dot"></div>
                                    <div class="dot"></div>
                                    <div class="dot"></div>
                                    <div class="dot"></div>
                                    <div class="dot"></div>
                                </div>
                            </button>
                        </form>
                    </div>

                </div>
            </div>


        </div>

        <style>
            /* Base Styles for AI Section */
            .insights-vertical-container {
                overflow-y: hidden;
                scrollbar-width: none;
                -ms-overflow-style: none;
            }

            .insights-vertical-container::-webkit-scrollbar {
                display: none;
            }

            /* Glassmorphism Cards */
            .insight-card-glass {
                background: rgba(255, 255, 255, 0.6);
                backdrop-filter: blur(15px);
                border: 1px solid rgba(255, 255, 255, 0.4);
                border-radius: 20px;
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.03);
                transition: transform 0.3s ease, background 0.3s, border-color 0.3s;
            }

            .insight-card-glass:hover {
                transform: scale(1.02);
                background: rgba(255, 255, 255, 0.85);
            }

            .icon-box-glass {
                width: 36px;
                height: 36px;
                background: white;
                border-radius: 12px;
                display: flex;
                align-items: center;
                justify-content: center;
                box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
                transition: background 0.3s;
                color: inherit;
                /* Allow parent text color */
            }

            /* Custom Chat Classes */


            /* DARK MODE OVERRIDES */
            [data-theme="dark"] .insight-card-glass {
                background: rgba(255, 255, 255, 0.05);
                border: 1px solid rgba(255, 255, 255, 0.1);
                box-shadow: none;
            }

            [data-theme="dark"] .insight-card-glass:hover {
                background: rgba(255, 255, 255, 0.1);
            }

            [data-theme="dark"] .icon-box-glass {
                background: rgba(255, 255, 255, 0.1);
                color: white !important;
            }

            /* Fix Chatbot Readability in Dark Mode */
            [data-theme="dark"] .bot-message .message-content {
                background-color: #1e293b;
                /* Dark Slate */
                color: #ffffff !important;
                border-color: rgba(255, 255, 255, 0.1);
            }

            [data-theme="dark"] .bot-message .message-time {
                color: #94a3b8 !important;
                /* Lighter gray for time */
            }

            [data-theme="dark"] #user-input {
                color: #ffffff !important;
            }

            [data-theme="dark"] #user-input::placeholder {
                color: #94a3b8;
            }

            /* Override bootstrap text colors in dark mode for icons if needed */
            [data-theme="dark"] .text-primary {
                color: #60a5fa !important;
            }

            [data-theme="dark"] .text-info {
                color: #38bdf8 !important;
            }

            [data-theme="dark"] .text-warning {
                color: #fbbf24 !important;
            }

            [data-theme="dark"] .text-danger {
                color: #f87171 !important;
            }

            [data-theme="dark"] .text-success {
                color: #34d399 !important;
            }

            [data-theme="dark"] .text-secondary {
                color: #9ca3af !important;
            }

            [data-theme="dark"] .text-muted {
                color: #9ca3af !important;
            }



            /* Animation for Vertical Scroll */
            .insights-track {
                display: flex;
                flex-direction: column;
                gap: 1.5rem;
                animation: scroll-vertical 40s linear infinite;
            }

            .insight-pack {
                display: flex;
                flex-direction: column;
                gap: 1rem;
            }

            @keyframes scroll-vertical {
                0% {
                    transform: translateY(0);
                }

                100% {
                    transform: translateY(-50%);
                }
            }

            @keyframes scroll-horizontal {
                0% {
                    transform: translateX(0);
                }

                100% {
                    transform: translateX(-50%);
                }
            }

            .insights-container-wrapper:hover .insights-track {
                animation-play-state: paused;
            }

            @media (max-width: 991px) {
                .insights-container-wrapper {
                    height: auto !important;
                    overflow: hidden !important;
                    padding-bottom: 2rem;
                    mask-image: linear-gradient(to right, transparent, black 5%, black 95%, transparent) !important;
                    -webkit-mask-image: linear-gradient(to right, transparent, black 5%, black 95%, transparent) !important;
                    display: flex;
                    align-items: center;
                }

                .insights-track {
                    flex-direction: row;
                    animation: scroll-horizontal 40s linear infinite;
                    /* Adjusted for horizontal speed */
                    gap: 1.5rem;
                    width: max-content;
                }

                .insight-pack {
                    flex-direction: row;
                    gap: 1.5rem;
                }

                .insight-card-glass {
                    min-width: 280px;
                    margin-bottom: 0 !important;
                }

                /* Chatbot adjustments */
                .chat-body {
                    max-height: 400px;
                }
            }

            .insight-card-glass {
                min-width: 260px;
                margin-bottom: 0 !important;
            }

            [data-theme="dark"] .insight-card-glass {
                background: rgba(30, 30, 30, 0.4);
                border-color: rgba(255, 255, 255, 0.08);
                box-shadow: none;
            }

            [data-theme="dark"] .insight-card-glass:hover {
                background: rgba(30, 30, 30, 0.6);
            }

            [data-theme="dark"] .icon-box-glass {
                background: rgba(255, 255, 255, 0.1);
                color: white !important;
            }

            /* Override Bootstrap text colors inside icons if needed */
            /* [data-theme="dark"] .icon-box-glass i { } */



            /* Aurelius Chat Styles */
            .aurelius-avatar {
                width: 45px;
                height: 45px;
                border-radius: 50%;
                background: #f1f5f9;
                padding: 2px;
                overflow: hidden;
            }

            .message {
                margin-bottom: 1rem;
                display: flex;
                flex-direction: column;
                max-width: 85%;
            }

            .bot-message {
                align-items: flex-start;
            }

            .user-message {
                align-items: flex-end;
                align-self: flex-end;
                margin-left: auto;
            }

            .message-content {
                padding: 0.8rem 1.2rem;
                border-radius: 18px;
                position: relative;
                font-size: 0.95rem;
                line-height: 1.5;
            }

            .bot-message .message-content {
                background: var(--bg-color);
                border-top-left-radius: 4px;
                border: 1px solid var(--border-color);
            }

            .user-message .message-content {
                background: var(--primary-color);
                color: white;
                border-bottom-right-radius: 4px;
                box-shadow: 0 4px 15px rgba(37, 99, 235, 0.2);
            }

            .message-time {
                font-size: 0.7rem;
                color: var(--text-muted);
                margin-top: 4px;
                margin-left: 4px;
            }

            .user-message .message-time {
                margin-right: 4px;
            }

            /* Typing Indicator */
            .typing-indicator span {
                display: inline-block;
                width: 6px;
                height: 6px;
                background-color: #adb5bd;
                border-radius: 50%;
                animation: typing 1.4s infinite ease-in-out both;
                margin: 0 1px;
            }

            .typing-indicator span:nth-child(1) {
                animation-delay: -0.32s;
            }

            .typing-indicator span:nth-child(2) {
                animation-delay: -0.16s;
            }

            @keyframes typing {

                0%,
                80%,
                100% {
                    transform: scale(0);
                }

                40% {
                    transform: scale(1);
                }
            }

            /* --- ORBITAL DOTS LOADER --- */
            .loader-dots {
                --uib-size: 28px;
                --uib-color: white;
                --uib-speed: 1.5s;
                --dot-size: calc(var(--uib-size) * 0.17);
                position: relative;
                display: flex;
                align-items: center;
                justify-content: flex-start;
                height: var(--uib-size);
                width: var(--uib-size);
                animation: smoothRotate calc(var(--uib-speed) * 1.8) linear infinite;
            }

            .loader-dots .dot {
                position: absolute;
                top: 0;
                left: 0;
                display: flex;
                align-items: flex-start;
                justify-content: center;
                height: 100%;
                width: 100%;
                animation: rotate var(--uib-speed) ease-in-out infinite;
            }

            .loader-dots .dot::before {
                content: '';
                height: var(--dot-size);
                width: var(--dot-size);
                border-radius: 50%;
                background-color: var(--uib-color);
                transition: background-color 0.3s ease;
            }

            .loader-dots .dot:nth-child(2),
            .loader-dots .dot:nth-child(2)::before {
                animation-delay: calc(var(--uib-speed) * -0.835 * 0.5);
            }

            .loader-dots .dot:nth-child(3),
            .loader-dots .dot:nth-child(3)::before {
                animation-delay: calc(var(--uib-speed) * -0.668 * 0.5);
            }

            .loader-dots .dot:nth-child(4),
            .loader-dots .dot:nth-child(4)::before {
                animation-delay: calc(var(--uib-speed) * -0.501 * 0.5);
            }

            .loader-dots .dot:nth-child(5),
            .loader-dots .dot:nth-child(5)::before {
                animation-delay: calc(var(--uib-speed) * -0.334 * 0.5);
            }

            .loader-dots .dot:nth-child(6),
            .loader-dots .dot:nth-child(6)::before {
                animation-delay: calc(var(--uib-speed) * -0.167 * 0.5);
            }

            @keyframes rotate {
                0% {
                    transform: rotate(0deg);
                }

                65%,
                100% {
                    transform: rotate(360deg);
                }
            }

            @keyframes smoothRotate {
                0% {
                    transform: rotate(0deg);
                }

                100% {
                    transform: rotate(360deg);
                }
            }

            /* --- GLASS MODAL STYLES (Responsive Dark Mode) --- */
            .glass-modal-overlay {
                backdrop-filter: blur(8px);
                background: rgba(0, 0, 0, 0.4);
            }

            .glass-modal-content {
                background: rgba(255, 255, 255, 0.85);
                backdrop-filter: blur(20px);
                -webkit-backdrop-filter: blur(20px);
                border: 1px solid rgba(255, 255, 255, 0.3);
                box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
                border-radius: 24px;
                max-width: 400px;
                margin: auto;
                color: var(--text-main);
                /* Default text color */
            }

            .glass-modal-title {
                color: #1e293b;
                /* Default Light Mode Title */
            }

            [data-theme="dark"] .glass-modal-content {
                background: rgba(30, 30, 30, 0.85);
                /* Darker background */
                border: 1px solid rgba(255, 255, 255, 0.1);
                box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.5);
                color: #e5e5e5;
            }

            [data-theme="dark"] .glass-modal-title {
                color: #ffffff !important;
            }

            [data-theme="dark"] #alert-icon-wrapper {
                background: rgba(255, 255, 255, 0.1) !important;
            }

            @media (max-width: 991px) {
                .insights-container-wrapper {
                    height: auto !important;
                    overflow: hidden !important;
                    padding-bottom: 2rem;
                    mask-image: linear-gradient(to right, transparent, black 5%, black 95%, transparent) !important;
                    -webkit-mask-image: linear-gradient(to right, transparent, black 5%, black 95%, transparent) !important;
                    display: flex;
                    align-items: center;
                }

                .insights-track {
                    flex-direction: row;
                    animation: scroll-horizontal 40s linear infinite;
                    /* Adjusted for horizontal speed */
                    gap: 1.5rem;
                    width: max-content;
                }

                .insight-pack {
                    flex-direction: row;
                    gap: 1.5rem;
                }

                .insight-card-glass {
                    min-width: 280px;
                    margin-bottom: 0 !important;
                }

                /* Chatbot adjustments */
                .chat-body {
                    max-height: 400px;
                }
            }
        </style>

        <script>
            // --- AURELIUS BRAIN (CHATBOT LOGIC) ---

            // Financial Data Injection
            const userFinancialData = {
                balance: parseFloat("{{ balance|replace(',', '') | float }}"),
                income: parseFloat("{{ current_month_income }}"),
                expense: parseFloat("{{ current_month_expenses }}"),
                topCategory: "{{ top_category }}",
                topCatPercentage: parseFloat("{{ top_cat_percentage }}"),
                savingsRate: parseFloat("{{ savings_rate }}"),
                name: "{{ name }}",
                subscriptions: [],
                goals: []
            };

            /* {% for sub in subscriptions %} */
            userFinancialData.subscriptions.push({
                name: "{{ sub.name }}",
                amount: parseFloat("{{ sub.amount }}")
            });
            /* {% endfor %} */

            /* {% for g in savings_goals %} */
            userFinancialData.goals.push({
                name: "{{ g.name }}",
                target: parseFloat("{{ g.target_amount }}"),
                current: parseFloat("{{ g.current_amount }}")
            });
            /* {% endfor %} */

            // --- CHAT MEMORY ---
            let chatHistory = [];

            const chatBody = document.getElementById('chat-body');
            const userInput = document.getElementById('user-input');

            function handleChatSubmit(e) {
                e.preventDefault();
                // Ensure we get fresh elements
                const userInputElem = document.getElementById('user-input');
                const text = userInputElem.value.trim();
                if (!text) return;

                // Hide Quick Prompts on manual usage too, to clean UI
                const quickPrompts = document.getElementById('quick-prompts');
                if (quickPrompts) quickPrompts.style.display = 'none';

                // Disable UI
                const sendBtn = document.getElementById('send-btn');
                const sendIcon = document.getElementById('send-icon');
                const sendSpinner = document.getElementById('send-spinner');

                userInputElem.disabled = true;
                sendBtn.disabled = true;
                sendIcon.classList.add('d-none');
                sendSpinner.classList.remove('d-none');

                // Add User Message
                addMessage(text, 'user');
                userInputElem.value = '';

                // Show Typing
                const typingId = showTyping();

                // Call API
                generateAureliusResponse(text).then(response => {
                    removeTyping(typingId);

                    // Show with Typewriter effect and WAIT for it to finish before resetting UI
                    typeMessage(response, 'bot', () => {
                        // Re-enable UI
                        userInputElem.disabled = false;
                        userInputElem.focus();
                        sendBtn.disabled = false;
                        sendIcon.classList.remove('d-none');
                        sendSpinner.classList.add('d-none');
                    });
                });
            }

            function sendPrompt(text) {
                addMessage(text, 'user');
                document.getElementById('quick-prompts').style.display = 'none';

                // Disable UI
                const userInputElem = document.getElementById('user-input');
                const sendBtn = document.getElementById('send-btn');
                const sendIcon = document.getElementById('send-icon');
                const sendSpinner = document.getElementById('send-spinner');

                userInputElem.disabled = true;
                sendBtn.disabled = true;
                sendIcon.classList.add('d-none');
                sendSpinner.classList.remove('d-none');

                const typingId = showTyping();

                generateAureliusResponse(text).then(response => {
                    removeTyping(typingId);

                    typeMessage(response, 'bot', () => {
                        // Re-enable UI
                        userInputElem.disabled = false;
                        userInputElem.focus();
                        sendBtn.disabled = false;
                        sendIcon.classList.remove('d-none');
                        sendSpinner.classList.add('d-none');
                    });
                });
            }

            function addMessage(text, sender) {
                const div = document.createElement('div');
                div.className = `message ${sender}-message fade-in`;

                const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

                div.innerHTML = `
                    <div class="message-content">
                        ${text}
                    </div>
                    <small class="message-time">${time}</small>
                `;

                chatBody.appendChild(div);
                scrollToBottom();
            }

            function typeMessage(text, sender, onComplete) {
                const div = document.createElement('div');
                div.className = `message ${sender}-message`; // No fade-in here, managed by typing
                const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

                // Create container content
                div.innerHTML = `
                    <div class="message-content"></div>
                    <small class="message-time">${time}</small>
                `;

                chatBody.appendChild(div);
                scrollToBottom();

                const contentDiv = div.querySelector('.message-content');
                let i = 0;

                // Detect HTML tags to avoid breaking them
                function typeChar() {
                    if (i < text.length) {
                        if (text.charAt(i) === '<') {
                            let tagEnd = text.indexOf('>', i);
                            if (tagEnd !== -1) {
                                contentDiv.innerHTML += text.substring(i, tagEnd + 1);
                                i = tagEnd + 1;
                            } else {
                                contentDiv.innerHTML += text.charAt(i);
                                i++;
                            }
                        } else {
                            contentDiv.innerHTML += text.charAt(i);
                            i++;
                        }
                        scrollToBottom();
                        setTimeout(typeChar, 15); // Typing speed
                    } else {
                        // Finished typing
                        if (onComplete) onComplete();
                    }
                }
                typeChar();
            }

            function showTyping() {
                const id = 'typing-' + Date.now();
                const div = document.createElement('div');
                div.className = `message bot-message fade-in`;
                div.id = id;
                div.innerHTML = `
                     <div class="message-content" style="padding: 0.8rem 1rem;">
                        <div class="typing-indicator">
                            <span></span><span></span><span></span>
                        </div>
                    </div>
                `;
                chatBody.appendChild(div);
                scrollToBottom();
                return id;
            }

            function removeTyping(id) {
                const el = document.getElementById(id);
                if (el) el.remove();
            }

            function scrollToBottom() {
                chatBody.scrollTop = chatBody.scrollHeight;
            }

            function clearChat() {
                chatHistory = []; // Reset memory
                chatBody.innerHTML = `
                    <div class="message bot-message fade-in">
                        <div class="message-content">
                            <p class="mb-1">¡Hola, <strong>${userFinancialData.name}</strong>! Soy Aurelius, tu asesor financiero personal.</p>
                            <p class="mb-0">Memoria reiniciada. ¿En qué puedo ayudarte ahora?</p>
                        </div>
                        <small class="message-time">Ahora mismo</small>
                    </div>
                `;
                document.getElementById('quick-prompts').style.display = 'block';
            }

            // --- LOGIC CORE ---
            async function generateAureliusResponse(input) {
                try {
                    const response = await fetch('/api/ask_aurelius', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': "{{ csrf_token() if csrf_token else '' }}" // Handle CSRF if present, otherwise ignore
                        },
                        body: JSON.stringify({
                            message: input,
                            history: chatHistory // Send previous history
                        })
                    });

                    if (!response.ok) throw new Error('Network response was not ok');

                    const data = await response.json();

                    // Update Memory
                    chatHistory.push({ role: "user", content: input });
                    chatHistory.push({ role: "assistant", content: data.response });

                    return data.response;

                } catch (error) {
                    console.error("Aurelius Error:", error);
                    return "Lo siento, mi conexión con la nube parece inestable. Por favor intenta de nuevo.";
                }
            }

            function formatMoney(amount) {
                return amount.toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,');
            }

            // --- INSIGHT MODALS LOGIC ---
            // Defined here to ensure it's accessible within this section context
            window.showInsightModal = function (type) {
                let title = '';
                let content = '';
                let icon = '';

                switch (type) {
                    case 'salud':
                        title = 'Salud financiera global';
                        icon = 'bi-heart-pulse text-primary';
                        content = `
                        <p class="mb-3">Este indicador es el "signos vitales" de tu economía. Representa qué porcentaje de tus ingresos logras retener cada mes.</p>
                        <h6 class="fw-bold text-muted small">¿Qué significan los niveles?</h6>
                        <ul class="text-list small text-muted mb-3">
                            <li class="mb-2"><b class="text-success">Excelente (>20%):</b> Estás construyendo riqueza. Este excedente deberías invertirlo.</li>
                            <li class="mb-2"><b class="text-warning">Estable (0-20%):</b> Gastas menos de lo que ganas, pero cualquier imprevisto podría desestabilizarte.</li>
                            <li class="mb-2"><b class="text-danger">Crítica (<0%):</b> Gastas más de lo que ganas. Estás generando deuda o quemando ahorros.</li>
                        </ul>
                        <p class="small text-muted border-top pt-2">Consejo Aurelius: Intenta subir al menos un 1% cada mes reduciendo gastos hormiga.</p>
                    `;
                        break;
                    case 'proyeccion':
                        title = 'Proyección de cierre mensual';
                        icon = 'bi-calendar-check text-info';
                        content = `
                        <p class="mb-3">Basado en tu comportamiento de gasto hasta el día de hoy, esto es lo que estimamos que habrás gastado al finalizar el mes.</p>
                        <h6 class="fw-bold text-muted small">¿Por qué es útil?</h6>
                        <p class="small text-muted mb-3">Te permite "ver el futuro". Si esta cifra supera tus ingresos esperados, significa que debes frenar tus gastos HOY mismo para no terminar en números rojos.</p>
                        <p class="small text-muted border-top pt-2">Consejo Aurelius: Revisa tus presupuestos si esta proyección te asusta.</p>
                    `;
                        break;
                    case 'ritmo':
                        title = 'Velocidad de gasto diario';
                        icon = 'bi-speedometer2 text-warning';
                        content = `
                        <p class="mb-3">Es el promedio de dinero que sale de tu bolsillo cada día.</p>
                        <h6 class="fw-bold text-muted small">Análisis rápido</h6>
                        <p class="small text-muted mb-3">Si multiplicas este número por 30 y el resultado es mayor a tu sueldo, tienes un problema estructural. A veces gastamos poco a poco, pero la suma diaria es letal.</p>
                        <p class="small text-muted border-top pt-2">Consejo Aurelius: Intenta tener "Días Cero" (días donde no gastes nada) para bajar este promedio.</p>
                    `;
                        break;
                    case 'fuga':
                        title = 'Fuga principal de capital';
                        icon = 'bi-pie-chart text-danger';
                        content = `
                        <p class="mb-3">Esta es la categoría donde más dinero se te está yendo este mes.</p>
                        <h6 class="fw-bold text-muted small">Estrategia de contención</h6>
                        <p class="small text-muted mb-3">No intentes ahorrar en todo a la vez. Enfócate en reducir solo un 10% en esta categoría específica y verás el mayor impacto en tus finanzas con el menor esfuerzo.</p>
                        <p class="small text-muted border-top pt-2">Consejo Aurelius: ¿Son gastos necesarios o emocionales?</p>
                    `;
                        break;
                    case 'fijos':
                        title = 'Carga fija estimada';
                        icon = 'bi-collection-play text-secondary';
                        content = `
                        <p class="mb-3">Suma total de tus suscripciones y pagos recurrentes detectados.</p>
                        <h6 class="fw-bold text-muted small">El peligro silencioso</h6>
                        <p class="small text-muted mb-3">Estos son "gastos vampiro". Salen de tu cuenta automáticamente y a menudo olvidamos que existen. Si la suma es alta, estás comprometiendo tu libertad financiera futura.</p>
                        <p class="small text-muted border-top pt-2">Consejo Aurelius: Cancela al menos una suscripción que no hayas usado en la última semana.</p>
                    `;
                        break;
                    case 'metas':
                        title = 'Progreso de objetivos';
                        icon = 'bi-trophy text-success';
                        content = `
                        <p class="mb-3">El porcentaje promedio de avance de todas tus metas de ahorro activas.</p>
                        <h6 class="fw-bold text-muted small">La importancia de visualizar</h6>
                        <p class="small text-muted mb-3">Tener metas claras (un viaje, un coche, fondo de emergencia) da propósito a tu dinero. Este medidor te dice qué tan cerca estás de hacerlas realidad.</p>
                        <p class="small text-muted border-top pt-2">Consejo Aurelius: Si el progreso es lento, intenta abonar montos pequeños pero frecuentes.</p>
                    `;
                        break;
                }

                // Show modal using the generic alert modal structure
                const modal = document.getElementById('alert-modal');
                const modalTitle = document.getElementById('alert-modal-title');
                const modalMsg = document.getElementById('alert-modal-msg');
                const alertIcon = document.getElementById('alert-modal-icon');
                const iconWrapper = document.getElementById('alert-icon-wrapper');

                if (modal && modalTitle && modalMsg) {
                    // Ensure proper capitalization in title is maintained as passed
                    modalTitle.innerHTML = title;
                    modalMsg.innerHTML = content;

                    // Pause Animation
                    const track = document.querySelector('.insights-vertical-track');
                    if (track) track.style.animationPlayState = 'paused';

                    if (alertIcon && iconWrapper) {
                        alertIcon.className = 'bi ' + icon + ' fs-1';
                        // Reset styling if needed
                        iconWrapper.style.background = 'rgba(0,0,0,0.05)';
                    }
                    modal.style.display = 'flex';

                    // Hide cancel button if exists, show OK
                    const cancelBtn = modal.querySelector('.btn-secondary');
                    if (cancelBtn) cancelBtn.style.display = 'none';
                }
            };
        </script>

        <!-- JS FOR MODALS (Refined) -->
        <script>
            // ... (We know existing modal script is fine, but we can update it if needed)
            // Leaving it to be handled by existign logic, but we must close the div.
        </script>
    </div>

    <!-- Profile Section (Hidden by Default) -->
    <div class="content-body d-none fade-in" id="section-profile">
        <div class="welcome-section mb-4">
            <h2 class="fw-bold mb-1">Mi perfil</h2>
            <p class="text-muted">Gestiona la información de tu cuenta y seguridad.</p>
        </div>

        <div class="row g-4 justify-content-center">
            <div class="col-lg-8">
                <!-- Personal Info Card -->
                <div class="card border-0 shadow-sm mb-4" style="background: var(--card-bg); border-radius: 24px;">
                    <div class="card-body p-4">
                        <h4 class="card-title mb-4 fw-bold" style="color: var(--text-main);">Información personal</h4>
                        <div class="mb-3">
                            <label class="form-label text-muted small">Nombre completo</label>
                            <div class="input-group-premium">
                                <i class="bi bi-person-fill"></i>
                                <input type="text" class="form-control-premium" value="{{ name }}" readonly
                                    style="cursor: not-allowed; opacity: 0.7;">
                            </div>
                            <small class="text-muted" style="font-size: 0.75rem;">El nombre no se puede
                                cambiar.</small>
                        </div>
                        <div class="mb-3">
                            <label class="form-label text-muted small">Correo electrónico</label>
                            <div class="input-group-premium">
                                <i class="bi bi-envelope-fill"></i>
                                <input type="text" class="form-control-premium" value="{{ current_user.email }}"
                                    readonly style="cursor: not-allowed; opacity: 0.7;">
                            </div>
                            <small class="text-muted" style="font-size: 0.75rem;">El correo es tu
                                identificador
                                único.</small>
                        </div>
                    </div>
                </div>

                <!-- Security Card -->
                <div class="card border-0 shadow-sm" style="background: var(--card-bg); border-radius: 24px;">
                    <div class="card-body p-4">
                        <h4 class="card-title mb-4 fw-bold" style="color: var(--text-main);">Seguridad</h4>
                        <form action="{{ url_for('update_password') }}" method="POST">
                            <div class="mb-3">
                                <label class="form-label text-muted small">Contraseña actual</label>
                                <div class="input-group-premium">
                                    <i class="bi bi-lock-fill"></i>
                                    <input type="password" name="current_password" id="current_password"
                                        class="form-control-premium" placeholder="Ingresa tu contraseña actual"
                                        required>
                                    <i class="bi bi-eye-slash toggle-password"
                                        onclick="togglePasswordVisibility('current_password', this)"></i>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label text-muted small">Nueva contraseña</label>
                                <div class="input-group-premium">
                                    <i class="bi bi-key-fill"></i>
                                    <input type="password" name="new_password" id="new_password"
                                        class="form-control-premium" placeholder="Ingresa la nueva contraseña" required>
                                    <i class="bi bi-eye-slash toggle-password"
                                        onclick="togglePasswordVisibility('new_password', this)"></i>
                                </div>
                            </div>
                            <div class="mb-4">
                                <label class="form-label text-muted small">Confirmar nueva
                                    contraseña</label>
                                <div class="input-group-premium">
                                    <i class="bi bi-check-circle-fill"></i>
                                    <input type="password" name="confirm_password" id="confirm_password"
                                        class="form-control-premium" placeholder="Repite la nueva contraseña" required>
                                    <i class="bi bi-eye-slash toggle-password"
                                        onclick="togglePasswordVisibility('confirm_password', this)"></i>
                                </div>
                            </div>

                            <button type="submit" class="btn btn-primary btn-premium w-100 py-3 rounded-pill">
                                <i class="bi bi-shield-lock-fill me-2"></i> Actualizar contraseña
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Help Modal for Reports -->
    <div id="help-modal" class="modal-overlay">
        <div class="modal-content text-center">
            <div class="mb-3">
                <i class="bi bi-info-circle fs-1 text-primary"></i>
            </div>
            <h3 id="helpTitle" class="fw-bold">Ayuda</h3>
            <p id="helpText" class="text-muted mb-4"></p>
            <button type="button" class="btn btn-primary rounded-pill px-4"
                onclick="document.getElementById('help-modal').style.display='none'">Entendido</button>
        </div>
    </div>

    <!-- Delete Goal Glass Modal -->
    <div id="delete-goal-modal" class="modal-overlay" style="backdrop-filter: blur(8px); background: rgba(0,0,0,0.4);">
        <div class="modal-content text-center p-5" style="
            background: rgba(255, 255, 255, 0.85); 
            backdrop-filter: blur(20px); 
            -webkit-backdrop-filter: blur(20px); 
            border: 1px solid rgba(255, 255, 255, 0.3); 
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37); 
            border-radius: 24px; 
            max-width: 400px;
            margin: auto;">

            <div class="mb-4">
                <div
                    style="width: 80px; height: 80px; background: rgba(239, 68, 68, 0.1); border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; margin: 0 auto;">
                    <i class="bi bi-trash3-fill text-danger fs-1"></i>
                </div>
            </div>

            <h3 class="fw-bold mb-3" style="color: #1e293b;">¿Eliminar meta?</h3>
            <p class="text-muted mb-4">Esta acción no se puede deshacer y perderás el registro de progreso.
            </p>

            <div class="d-flex gap-3 justify-content-center">
                <button class="btn btn-light rounded-pill px-4 py-2" onclick="closeDeleteGoalModal()">Cancelar</button>
                <button id="confirmDeleteGoalBtn" class="btn btn-danger rounded-pill px-4 py-2 fw-bold shadow-sm">Sí,
                    eliminar</button>
            </div>
        </div>
    </div>

    <!-- Generic Glass Confirmation Modal -->
    <div id="confirmation-modal" class="modal-overlay" style="backdrop-filter: blur(8px); background: rgba(0,0,0,0.4);">
        <div class="modal-content text-center p-5" style="
            background: rgba(255, 255, 255, 0.85); 
            backdrop-filter: blur(20px); 
            -webkit-backdrop-filter: blur(20px); 
            border: 1px solid rgba(255, 255, 255, 0.3); 
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37); 
            border-radius: 24px; 
            max-width: 400px;
            margin: auto;">

            <div class="mb-4">
                <div
                    style="width: 80px; height: 80px; background: rgba(37,99,235,0.1); border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; margin: 0 auto;">
                    <i class="bi bi-question-lg text-primary fs-1"></i>
                </div>
            </div>

            <h3 id="conf-modal-title" class="fw-bold mb-3" style="color: #1e293b;">¿Estás seguro?</h3>
            <p id="conf-modal-msg" class="text-muted mb-4">Esta acción no se puede deshacer.</p>

            <div class="d-flex gap-3 justify-content-center">
                <button class="btn btn-light rounded-pill px-4 py-2"
                    onclick="closeConfirmationModal()">Cancelar</button>
                <button id="conf-modal-btn"
                    class="btn btn-primary rounded-pill px-4 py-2 fw-bold shadow-sm">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- Generic Glass Alert Modal -->
    <!-- Generic Glass Alert Modal -->
    <div id="alert-modal" class="modal-overlay glass-modal-overlay">
        <div class="modal-content glass-modal-content text-center p-5">

            <div class="mb-4">
                <div id="alert-icon-wrapper"
                    style="width: 80px; height: 80px; background: rgba(16, 185, 129, 0.1); border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; margin: 0 auto;">
                    <i id="alert-modal-icon" class="bi bi-check-circle-fill text-success fs-1"></i>
                </div>
            </div>

            <h3 id="alert-modal-title" class="fw-bold mb-3 glass-modal-title">Éxito</h3>
            <p id="alert-modal-msg" class="text-muted mb-4">Operación realizada correctamente.</p>

            <div class="d-flex gap-3 justify-content-center">
                <button class="btn btn-primary rounded-pill px-5 py-2 fw-bold shadow-sm"
                    onclick="closeAlertModal()">Entendido</button>
            </div>
        </div>
    </div>

    <!-- Add Goal Modal -->
    <div id="add-goal-modal" class="modal-overlay">
        <div class="modal-content">
            <h3>Nueva meta de ahorro</h3>
            <form action="{{ url_for('add_savings_goal') }}" method="POST">
                <div class="mb-3 text-start">
                    <label class="form-label text-muted small">Nombre de la meta</label>
                    <input type="text" name="name" class="form-control" placeholder="Ej: Viaje a Japón" required>
                </div>
                <div class="mb-3 text-start">
                    <label class="form-label text-muted small">Monto objetivo</label>
                    <input type="number" step="0.01" name="target_amount" class="form-control" placeholder="0.00"
                        required>
                </div>
                <div class="mb-3 text-start">
                    <label class="form-label text-muted small">Ahorro inicial (Opcional)</label>
                    <input type="number" step="0.01" name="initial_amount" class="form-control" placeholder="0.00">
                </div>
                <div class="mb-3 text-start">
                    <label class="form-label text-muted small">Fecha objetivo</label>
                    <input type="date" name="target_date" class="form-control" required>
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn-cancel"
                        onclick="document.getElementById('add-goal-modal').style.display='none'">Cancelar</button>
                    <button type="submit" class="btn-confirm">Crear meta</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Funds Modal -->
    <div id="add-funds-modal" class="modal-overlay">
        <div class="modal-content">
            <h3>Abonar a la meta</h3>
            <p id="fundGoalName" class="text-muted small mb-3">Meta: --</p>
            <form id="addFundsForm" method="POST">
                <div class="mb-3 text-start">
                    <label class="form-label text-muted small">Monto a abonar</label>
                    <input type="number" step="0.01" name="amount" class="form-control" placeholder="0.00" required>
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn-cancel"
                        onclick="document.getElementById('add-funds-modal').style.display='none'">Cancelar</button>
                    <button type="submit" class="btn-confirm">Abonar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Transaction Modal -->
    <div id="edit-modal" class="modal-overlay">
        <div class="modal-content">
            <h3>Editar movimiento</h3>
            <form id="editForm" method="POST">
                <div class="mb-3 text-start">
                    <label class="form-label text-muted small">Título</label>
                    <input type="text" name="title" id="editTitle" class="form-control" required>
                </div>
                <div class="mb-3 text-start">
                    <label class="form-label text-muted small">Monto</label>
                    <input type="number" step="0.01" name="amount" id="editAmount" class="form-control" required>
                </div>
                <div class="mb-3 text-start">
                    <label class="form-label text-muted small">Tipo</label>
                    <select name="type" id="editType" class="form-select" required>
                        <option value="expense">Gasto</option>
                        <option value="income">Ingreso</option>
                    </select>
                </div>
                <div class="mb-3 text-start">
                    <label class="form-label text-muted small">Categoría</label>
                    <select name="category" id="editCategory" class="form-select" required>
                        <option value="Comida">Comida</option>
                        <option value="Transporte">Transporte</option>
                        <option value="Vivienda">Vivienda</option>
                        <option value="Salud">Salud</option>
                        <option value="Entretenimiento">Entretenimiento</option>
                        <option value="Salario">Salario</option>
                        <option value="Otros">Otros</option>
                    </select>
                </div>
                <div class="mb-3 text-start">
                    <label class="form-label text-muted small">Fecha</label>
                    <input type="date" name="date" id="editDate" class="form-control">
                </div>

                <div class="modal-actions">
                    <button type="button" id="cancel-edit" class="btn-cancel">Cancelar</button>
                    <button type="submit" class="btn-confirm">Guardar cambios</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Subscription Modal -->
    <div id="subscription-modal" class="modal-overlay">
        <div class="modal-content">
            <h3>Nueva suscripción</h3>
            <form action="{{ url_for('add_subscription') }}" method="POST">
                <div class="mb-3 text-start">
                    <label class="form-label text-muted small">Nombre del servicio</label>
                    <input type="text" name="name" class="form-control" placeholder="Ej: Netflix" required>
                </div>
                <div class="mb-3 text-start">
                    <label class="form-label text-muted small">Monto</label>
                    <input type="number" step="0.01" name="amount" class="form-control" placeholder="0.00" required>
                </div>
                <div class="mb-3 text-start">
                    <label class="form-label text-muted small">Categoría</label>
                    <select name="category" class="form-select" required>
                        <option value="Entretenimiento">Entretenimiento</option>
                        <option value="Vivienda">Vivienda</option>
                        <option value="Salud">Salud</option>
                        <option value="Transporte">Transporte</option>
                        <option value="Otros">Otros</option>
                    </select>
                </div>
                <div class="mb-3 text-start">
                    <label class="form-label text-muted small">Periodo de facturación</label>
                    <select name="billing_period" class="form-select" required>
                        <option value="mensual">Mensual</option>
                        <option value="anual">Anual</option>
                    </select>
                </div>
                <div class="mb-3 text-start">
                    <label class="form-label text-muted small">Fecha de inicio/próximo cobro</label>
                    <input type="date" name="start_date" class="form-control" required>
                    <small class="text-muted" style="font-size: 0.7rem;">Si pones una fecha pasada, se
                        cobrará
                        inmediatamente.</small>
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn-cancel"
                        onclick="document.getElementById('subscription-modal').style.display='none'">Cancelar</button>
                    <button type="submit" class="btn-confirm">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Logout Modal -->
    <div id="logout-modal" class="modal-overlay">
        <div class="modal-content">
            <h3>Cerrar sesión</h3>
            <p>¿Estás seguro de que deseas cerrar tu sesión?</p>
            <div class="modal-actions">
                <button id="cancel-logout" class="btn-cancel">Cancelar</button>
                <button id="confirm-logout" class="btn-confirm">Cerrar sesión</button>
            </div>
        </div>
    </div>


    <!-- FAQ Modal -->
    <div id="faq-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 600px; text-align: left;">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h3 class="mb-0 fw-bold">Ayuda y soporte</h3>
                <button type="button" class="btn-close" onclick="closeFAQModal()" aria-label="Close"></button>
            </div>
            <p class="text-muted small mb-4">Preguntas frecuentes sobre FinanzApp.</p>

            <div class="accordion accordion-flush" id="faqAccordion">

                <!-- Q1 -->
                <div class="accordion-item bg-transparent border-bottom">
                    <h2 class="accordion-header" id="flush-headingOne">
                        <button class="accordion-button collapsed bg-transparent shadow-none fw-bold text-main"
                            type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseOne">
                            ¿Aurelius puede ver mis contraseñas bancarias?
                        </button>
                    </h2>
                    <div id="flush-collapseOne" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                        <div class="accordion-body text-muted small">
                            No. Aurelius solo tiene acceso a los datos que tú registras manualmente en la aplicación
                            (ingresos, gastos, metas). No se conecta a tu banco ni almacena credenciales externas.
                        </div>
                    </div>
                </div>

                <!-- Q2 -->
                <div class="accordion-item bg-transparent border-bottom">
                    <h2 class="accordion-header" id="flush-headingTwo">
                        <button class="accordion-button collapsed bg-transparent shadow-none fw-bold text-main"
                            type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseTwo">
                            ¿Cómo elimino un movimiento incorrecto?
                        </button>
                    </h2>
                    <div id="flush-collapseTwo" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                        <div class="accordion-body text-muted small">
                            Ve a la sección "Movimientos" o al "Panel de Control". En la lista de historial, cada fila
                            tiene un botón de basura rojo. Haz clic ahí para borrarlo permanentemente.
                        </div>
                    </div>
                </div>

                <!-- Q3 -->
                <div class="accordion-item bg-transparent border-bottom">
                    <h2 class="accordion-header" id="flush-headingThree">
                        <button class="accordion-button collapsed bg-transparent shadow-none fw-bold text-main"
                            type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseThree">
                            ¿Qué pasa si me excedo en un presupuesto?
                        </button>
                    </h2>
                    <div id="flush-collapseThree" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                        <div class="accordion-body text-muted small">
                            La barra del presupuesto se pondrá roja y verás un porcentaje superior al 100%. No se
                            bloquean tus gastos, pero Aurelius te avisará para que moderes tu consumo.
                        </div>
                    </div>
                </div>

                <!-- Q4 -->
                <div class="accordion-item bg-transparent border-bottom">
                    <h2 class="accordion-header" id="flush-headingFour">
                        <button class="accordion-button collapsed bg-transparent shadow-none fw-bold text-main"
                            type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseFour">
                            ¿Puedo exportar mi información a Excel?
                        </button>
                    </h2>
                    <div id="flush-collapseFour" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                        <div class="accordion-body text-muted small">
                            Sí. En la sección "Reportes", puedes descargar un resumen mensual en PDF. La exportación a
                            Excel (.csv) detallada está disponible en el Panel de Reportes.
                        </div>
                    </div>
                </div>

                <!-- Q5 -->
                <div class="accordion-item bg-transparent border-bottom">
                    <h2 class="accordion-header" id="flush-headingFive">
                        <button class="accordion-button collapsed bg-transparent shadow-none fw-bold text-main"
                            type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseFive">
                            ¿Cómo cambio mi contraseña?
                        </button>
                    </h2>
                    <div id="flush-collapseFive" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                        <div class="accordion-body text-muted small">
                            Ve a "Mi perfil" en el menú principal. Ahí encontrarás una tarjeta de Seguridad donde puedes
                            actualizar tu contraseña actual.
                        </div>
                    </div>
                </div>

                <!-- Q6 -->
                <div class="accordion-item bg-transparent border-bottom">
                    <h2 class="accordion-header" id="flush-headingSix">
                        <button class="accordion-button collapsed bg-transparent shadow-none fw-bold text-main"
                            type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseSix">
                            ¿Para qué sirven las Metas de Ahorro?
                        </button>
                    </h2>
                    <div id="flush-collapseSix" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                        <div class="accordion-body text-muted small">
                            Te ayudan a apartar dinero virtualmente para un objetivo (viaje, coche). Aurelius calcula
                            cuánto debes ahorrar al día o semana para llegar a la fecha meta.
                        </div>
                    </div>
                </div>

                <!-- Q7 -->
                <div class="accordion-item bg-transparent border-bottom">
                    <h2 class="accordion-header" id="flush-headingSeven">
                        <button class="accordion-button collapsed bg-transparent shadow-none fw-bold text-main"
                            type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseSeven">
                            ¿Cómo registro una suscripción mensual?
                        </button>
                    </h2>
                    <div id="flush-collapseSeven" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                        <div class="accordion-body text-muted small">
                            En la sección "Movimientos", cambia a la pestaña "Suscripciones". Registra el servicio (ej.
                            Netflix) y la fecha de cobro. El sistema creará el gasto automáticamente cada mes.
                        </div>
                    </div>
                </div>

                <!-- Q8 -->
                <div class="accordion-item bg-transparent border-bottom">
                    <h2 class="accordion-header" id="flush-headingEight">
                        <button class="accordion-button collapsed bg-transparent shadow-none fw-bold text-main"
                            type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseEight">
                            ¿Qué significa el indicador "Salud Financiera"?
                        </button>
                    </h2>
                    <div id="flush-collapseEight" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                        <div class="accordion-body text-muted small">
                            Es un cálculo basado en tu tasa de ahorro. Si ahorras más del 20% de lo que ganas, tu salud
                            es "Excelente". Si gastas más de lo que ingresas, es "Crítica".
                        </div>
                    </div>
                </div>

                <!-- Q9 -->
                <div class="accordion-item bg-transparent border-bottom">
                    <h2 class="accordion-header" id="flush-headingNine">
                        <button class="accordion-button collapsed bg-transparent shadow-none fw-bold text-main"
                            type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseNine">
                            ¿Puedo usar la app en modo oscuro?
                        </button>
                    </h2>
                    <div id="flush-collapseNine" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                        <div class="accordion-body text-muted small">
                            ¡Sí! En la barra superior (junto a tu perfil) hay un icono de luna/sol. Toca ahí para
                            alternar entre el tema claro y oscuro instantáneamente.
                        </div>
                    </div>
                </div>

                <!-- Q10 -->
                <div class="accordion-item bg-transparent border-bottom">
                    <h2 class="accordion-header" id="flush-headingTen">
                        <button class="accordion-button collapsed bg-transparent shadow-none fw-bold text-main"
                            type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseTen">
                            Tengo otra duda, ¿cómo contacto soporte real?
                        </button>
                    </h2>
                    <div id="flush-collapseTen" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                        <div class="accordion-body text-muted small">
                            Si este FAQ no resolvió tu problema, puedes escribirnos directamente a soporte@finanzapp.com
                            y te responderemos en menos de 24 horas.
                        </div>
                    </div>
                </div>

            </div>

            <div class="modal-actions mt-4">
                <button type="button" class="btn-confirm w-100" onclick="closeFAQModal()">Entendido</button>
            </div>
        </div>
    </div>


    <div id="schedule-modal" class="modal-overlay">
        <div class="modal-content">
            <h3>Programar movimiento</h3>
            <p id="scheduleDateDisplay" class="text-muted small mb-3">Para el --/--/----</p>
            <form action="{{ url_for('movements')}}" method="POST" id="scheduleForm">
                <input type="hidden" name="date" id="scheduleDateInput">

                <div class="mb-3">
                    <label class="form-label text-muted small ms-1">Tipo de movimiento</label>
                    <div class="transaction-toggle-container">
                        <input type="radio" name="type" id="s-expense" value="expense" checked hidden
                            onchange="updateScheduleToggle(this)">
                        <label for="s-expense" class="toggle-option active-expense" id="s-label-expense">
                            <i class="bi bi-arrow-down-circle-fill"></i> Gasto
                        </label>

                        <input type="radio" name="type" id="s-income" value="income" hidden
                            onchange="updateScheduleToggle(this)">
                        <label for="s-income" class="toggle-option" id="s-label-income">
                            <i class="bi bi-arrow-up-circle-fill"></i> Ingreso
                        </label>
                    </div>
                </div>

                <div class="mb-3 text-start">
                    <label class="form-label text-muted small">Título</label>
                    <input type="text" name="title" class="form-control" placeholder="Ej: Pago de Luz" required>
                </div>
                <div class="mb-3 text-start">
                    <label class="form-label text-muted small">Monto</label>
                    <input type="number" step="0.01" name="amount" class="form-control" placeholder="0.00" required>
                </div>
                <div class="mb-3 text-start">
                    <label class="form-label text-muted small">Categoría</label>
                    <select name="category" class="form-select" required>
                        <option value="" disabled selected>Seleccionar</option>
                        <option value="Comida">Comida</option>
                        <option value="Transporte">Transporte</option>
                        <option value="Vivienda">Vivienda</option>
                        <option value="Salud">Salud</option>
                        <option value="Entretenimiento">Entretenimiento</option>
                        <option value="Salario">Salario</option>
                        <option value="Otros">Otros</option>
                    </select>
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn-cancel" onclick="closeScheduleModal()">Cancelar</button>
                    <button type="submit" class="btn-confirm">Programar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Scripts for Schedule Modal and Toggle -->
    <script>
        function closeScheduleModal() {
            document.getElementById('schedule-modal').style.display = 'none';
        }

        window.updateScheduleToggle = function (element) {
            const isExpense = element.value === 'expense';
            const labelExpense = document.getElementById('s-label-expense');
            const labelIncome = document.getElementById('s-label-income');

            if (isExpense) {
                labelExpense.classList.add('active-expense');
                labelIncome.classList.remove('active-income');
            } else {
                labelExpense.classList.remove('active-expense');
                labelIncome.classList.add('active-income');
            }
        }

        // Also close on outside click (globally handled in existing listener but let's ensure it covers this new modal)
        window.addEventListener('click', (e) => {
            const sModal = document.getElementById('schedule-modal');
            if (e.target === sModal) {
                sModal.style.display = 'none';
            }
        });
    </script>
    {% endblock %}

    {% block scripts %}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script id="transactions-data" type="application/json">
    {{ transactions_data | tojson | safe }}
</script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- THEME LOGIC (MUST RUN FIRST) ---
            const themeToggleBtn = document.getElementById('theme-toggle');
            const themeIcon = themeToggleBtn.querySelector('i');
            const body = document.body;

            // Apply saved theme immediately
            if (localStorage.getItem('theme') === 'dark') {
                body.setAttribute('data-theme', 'dark');
                if (themeIcon) {
                    themeIcon.classList.remove('fa-moon');
                    themeIcon.classList.add('fa-sun');
                }
            }

            if (themeToggleBtn) {
                themeToggleBtn.addEventListener('click', () => {
                    let isDark = false;
                    if (body.hasAttribute('data-theme')) {
                        body.removeAttribute('data-theme');
                        localStorage.setItem('theme', 'light');
                        isDark = false;
                        if (themeIcon) {
                            themeIcon.classList.remove('fa-sun');
                            themeIcon.classList.add('fa-moon');
                        }
                    } else {
                        body.setAttribute('data-theme', 'dark');
                        localStorage.setItem('theme', 'dark');
                        isDark = true;
                        if (themeIcon) {
                            themeIcon.classList.remove('fa-moon');
                            themeIcon.classList.add('fa-sun');
                        }
                    }

                    // Update Charts Seamlesly
                    const newTextColor = isDark ? '#ffffff' : '#000000';
                    const newGridColor = isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(128, 128, 128, 0.1)';

                    Chart.defaults.color = newTextColor;
                    Chart.defaults.scale.grid.color = newGridColor;

                    if (window.cashFlowChartInstance) {
                        window.cashFlowChartInstance.options.scales.x.grid.color = 'rgba(0,0,0,0)'; // Hide x grid usually
                        window.cashFlowChartInstance.options.scales.y.grid.color = newGridColor;

                        // Explicitly update Tick Colors
                        window.cashFlowChartInstance.options.scales.x.ticks.color = newTextColor;
                        window.cashFlowChartInstance.options.scales.y.ticks.color = newTextColor;

                        window.cashFlowChartInstance.options.plugins.legend.labels.color = newTextColor;
                        window.cashFlowChartInstance.update();
                    }
                    if (window.expensesChartInstance) {
                        window.expensesChartInstance.options.plugins.legend.labels.color = newTextColor;
                        window.expensesChartInstance.update();
                    }
                });
            }
            // --- PROCESAMIENTO DE DATOS PARA GRÁFICOS ---
            // --- PROCESAMIENTO DE DATOS PARA GRÁFICOS ---
            const transDataElement = document.getElementById('transactions-data');
            let transactions = [];
            let categories = {};
            let categoryLabels = [];
            let categoryData = [];
            let dailyFlow = {};
            let sortedDates = [];
            let incomeData = [];
            let expenseData = [];
            let dateLabels = [];

            if (transDataElement) {
                try {
                    transactions = JSON.parse(transDataElement.textContent);

                    // 1. Datos para Gastos por Categoría
                    transactions.filter(t => t.type === 'expense').forEach(t => {
                        categories[t.category] = (categories[t.category] || 0) + t.amount;
                    });

                    categoryLabels = Object.keys(categories);
                    categoryData = Object.values(categories);

                    // 2. Datos para Flujo de Caja (Agrupado por día)
                    transactions.forEach(t => {
                        if (!dailyFlow[t.date]) {
                            dailyFlow[t.date] = { income: 0, expense: 0 };
                        }
                        if (t.type === 'income') dailyFlow[t.date].income += t.amount;
                        if (t.type === 'expense') dailyFlow[t.date].expense += t.amount;
                    });

                    // Ordenar fechas
                    sortedDates = Object.keys(dailyFlow).sort();
                    incomeData = sortedDates.map(date => dailyFlow[date].income);
                    expenseData = sortedDates.map(date => dailyFlow[date].expense);

                    // Formatear fechas
                    dateLabels = sortedDates.map(date => {
                        const [y, m, d] = date.split('-');
                        return `${d}/${m}`;
                    });
                } catch (e) {
                    console.error('Error parsing transactions data', e);
                }
            }


            // --- CONFIGURACIÓN DE COLORES ---
            const colors = {
                primary: '#2563eb',   // Azul vibrante
                success: '#10b981',   // Verde esmeralda
                danger: '#ef4444',    // Rojo brillante
                text: getComputedStyle(document.body).getPropertyValue('--text-main').trim(),
                grid: 'rgba(128, 128, 128, 0.1)',
                purple: '#8b5cf6',
                orange: '#f97316',
                teal: '#14b8a6',
                pink: '#ec4899',
                yellow: '#eab308'
            };

            // Paleta para categorías
            const categoryColors = [
                colors.primary, colors.purple, colors.orange, colors.teal, colors.pink, colors.yellow, colors.success
            ];

            // Configuración Global de Fuentes
            Chart.defaults.font.family = "'Poppins', sans-serif";
            Chart.defaults.color = colors.text;
            Chart.defaults.scale.grid.color = colors.grid;

            // --- INICIALIZAR GRÁFICOS ---

            window.renderDashboardCharts = function () {
                const canvasFlow = document.getElementById('cashFlowChart');
                const canvasExp = document.getElementById('expensesChart');

                if (!canvasFlow && !canvasExp) return;

                // DESTROY EXISTING INSTANCES to force re-animation and correct sizing
                if (window.cashFlowChartInstance) {
                    window.cashFlowChartInstance.destroy();
                    window.cashFlowChartInstance = null;
                }
                if (window.expensesChartInstance) {
                    window.expensesChartInstance.destroy();
                    window.expensesChartInstance = null;
                }

                if (canvasFlow) {
                    // Logic to make chart scrollable if many dates
                    const container = document.getElementById('cashFlowContainer');
                    const minWidthPerDay = window.innerWidth < 768 ? 50 : 30; // More space on mobile
                    const requiredWidth = dateLabels.length * minWidthPerDay;

                    if (container && dateLabels.length > 5) {
                        if (requiredWidth > container.parentElement.clientWidth) {
                            container.style.width = `${requiredWidth}px`;
                        }
                    }

                    const ctxFlow = canvasFlow.getContext('2d');
                    window.cashFlowChartInstance = new Chart(ctxFlow, {
                        type: 'bar',
                        data: {
                            labels: dateLabels,
                            datasets: [
                                {
                                    label: 'Ingresos',
                                    data: incomeData,
                                    borderColor: colors.success,
                                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                                    borderWidth: 2,
                                    tension: 0.4,
                                    fill: true,
                                    pointRadius: 4,
                                    pointHoverRadius: 6
                                },
                                {
                                    label: 'Gastos',
                                    data: expenseData,
                                    borderColor: colors.danger,
                                    backgroundColor: 'rgba(239, 68, 68, 0.1)',
                                    borderWidth: 2,
                                    tension: 0.4,
                                    fill: true,
                                    pointRadius: 4,
                                    pointHoverRadius: 6
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            animation: {
                                duration: 1000,
                                easing: 'easeOutQuart'
                            },
                            plugins: {
                                legend: { position: 'top', labels: { usePointStyle: true, padding: 20 } },
                                tooltip: {
                                    mode: 'index',
                                    intersect: false,
                                    backgroundColor: 'rgba(255, 255, 255, 0.9)',
                                    titleColor: '#1e293b',
                                    bodyColor: '#475569',
                                    borderColor: 'rgba(0,0,0,0.05)',
                                    borderWidth: 1,
                                    padding: 10,
                                    displayColors: true
                                }
                            },
                            scales: {
                                y: { beginAtZero: true, grid: { borderDash: [2, 4] } },
                                x: { grid: { display: false } }
                            }
                        }
                    });
                }

                if (canvasExp) {
                    const ctxCat = canvasExp.getContext('2d');
                    if (categoryData.length === 0) {
                        window.expensesChartInstance = new Chart(ctxCat, {
                            type: 'doughnut',
                            data: {
                                labels: ['Sin gastos'],
                                datasets: [{
                                    data: [1],
                                    backgroundColor: ['#e5e7eb'],
                                    borderWidth: 0
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: { legend: { display: false }, tooltip: { enabled: false } }
                            }
                        });
                    } else {
                        window.expensesChartInstance = new Chart(ctxCat, {
                            type: 'doughnut',
                            data: {
                                labels: categoryLabels,
                                datasets: [{
                                    data: categoryData,
                                    backgroundColor: categoryColors,
                                    borderWidth: 2,
                                    borderColor: getComputedStyle(document.body).getPropertyValue('--card-bg').trim(),
                                    hoverOffset: 10
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                cutout: '70%',
                                animation: {
                                    animateScale: true,
                                    animateRotate: true
                                },
                                plugins: {
                                    legend: {
                                        position: 'right', // Leyenda a la derecha para estilo dashboard
                                        labels: { usePointStyle: true, padding: 15, font: { size: 12 } }
                                    },
                                    tooltip: {
                                        callbacks: {
                                            label: function (context) {
                                                let label = context.label || '';
                                                if (label) {
                                                    label += ': ';
                                                }
                                                if (context.parsed !== null) {
                                                    label += new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(context.parsed);
                                                }
                                                return label;
                                            }
                                        }
                                    }
                                }
                            }
                        });
                    }
                }
            };

            // Initial Render if on dashboard
            const initialSection = localStorage.getItem('activeSection') || 'dashboard';
            if (initialSection === 'dashboard') {
                window.renderDashboardCharts();
            }

            // --- SUBSCRIPTION MANAGEMENT FUNCTIONS ---
            const editSubscriptionModal = document.getElementById('edit-subscription-modal');
            const editSubscriptionForm = document.getElementById('editSubscriptionForm');
            const cancelEditSubscriptionBtn = document.getElementById('cancel-edit-subscription');

            if (cancelEditSubscriptionBtn) {
                cancelEditSubscriptionBtn.addEventListener('click', () => {
                    editSubscriptionModal.style.display = 'none';
                });
            }

            window.openEditSubscriptionModal = function (id) {
                fetch(`/get_subscription/${id}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            document.getElementById('editSubscriptionTitle').value = data.title;
                            document.getElementById('editSubscriptionAmount').value = data.amount;
                            document.getElementById('editSubscriptionCategory').value = data.category;
                            document.getElementById('editSubscriptionFrequency').value = data.frequency;
                            document.getElementById('editSubscriptionNextPayment').value = data.next_payment_date;

                            editSubscriptionForm.action = `/edit_subscription/${id}`;
                            editSubscriptionModal.style.display = 'flex';
                        } else {
                            if (window.openAlertModal) window.openAlertModal('Error', 'Error al cargar datos de la suscripción', true);
                            else alert('Error al cargar datos');
                        }
                    })
                    .catch(err => console.error(err));
            }

            window.deleteSubscription = function (id) {
                if (window.openConfirmationModal) {
                    window.openConfirmationModal(
                        '¿Cancelar suscripción?',
                        'Dejará de cobrarse automáticamente, pero el historial se mantendrá.',
                        'Cancelar',
                        function () {
                            fetch(`/delete_subscription/${id}`, { method: 'POST' })
                                .then(response => response.json())
                                .then(data => {
                                    if (data.success) location.reload();
                                    else window.openAlertModal('Error', 'No se pudo eliminar', true);
                                });
                        }
                    );
                } else {
                    // Fallback
                    if (confirm('¿Deseas cancelar esta suscripción?')) {
                        fetch(`/delete_subscription/${id}`, { method: 'POST' })
                            .then(response => response.json())
                            .then(data => {
                                if (data.success) location.reload();
                                else alert('Error al eliminar');
                            });
                    }
                }
            }

            // --- MOBILE SIDEBAR LOGIC ---
            const openSidebarBtn = document.getElementById('openSidebar');
            const closeSidebarBtn = document.getElementById('closeSidebar');
            const sidebar = document.querySelector('.sidebar');
            const mainWrapper = document.querySelector('.main-wrapper'); // Target for blur

            // Create Overlay dynamically
            let sidebarOverlay = document.getElementById('sidebar-overlay');
            if (!sidebarOverlay) {
                sidebarOverlay = document.createElement('div');
                sidebarOverlay.id = 'sidebar-overlay';
                document.body.appendChild(sidebarOverlay);
            }

            function toggleSidebar(show) {
                if (show) {
                    sidebar.classList.add('active');
                    sidebarOverlay.classList.add('active');
                    document.body.classList.add('sidebar-open');
                    mainWrapper.style.filter = 'blur(5px)'; // Apply blur specifically to content
                    mainWrapper.style.transition = 'filter 0.3s ease';
                } else {
                    sidebar.classList.remove('active');
                    sidebarOverlay.classList.remove('active');
                    document.body.classList.remove('sidebar-open');
                    mainWrapper.style.filter = 'none';
                }
            }

            if (openSidebarBtn) {
                openSidebarBtn.addEventListener('click', () => toggleSidebar(true));
            }

            if (closeSidebarBtn) {
                closeSidebarBtn.addEventListener('click', () => toggleSidebar(false));
            }

            // Close on overlay click
            sidebarOverlay.addEventListener('click', () => toggleSidebar(false));

            // Close on nav link click (mobile UX)
            document.querySelectorAll('.sidebar .nav-link').forEach(link => {
                link.addEventListener('click', () => {
                    if (window.innerWidth < 992) {
                        toggleSidebar(false);
                    }
                });
            });

            // --- TRANSACTION MANAGEMENT FUNCTIONS ---
            // Defined inside DOMContentLoaded but attached to window to be accessible by HTML onclick

            const editModal = document.getElementById('edit-modal');
            const editForm = document.getElementById('editForm');
            const cancelEditBtn = document.getElementById('cancel-edit');

            if (cancelEditBtn) {
                cancelEditBtn.addEventListener('click', () => {
                    editModal.style.display = 'none';
                });
            }

            // Close modal on outside click
            window.addEventListener('click', (e) => {
                if (e.target === editModal) {
                    editModal.style.display = 'none';
                }
            });

            window.openEditModal = function (id) {
                fetch(`/get_transaction/${id}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            document.getElementById('editTitle').value = data.title;
                            document.getElementById('editAmount').value = data.amount;
                            document.getElementById('editType').value = data.type;
                            document.getElementById('editCategory').value = data.category;
                            if (data.date) document.getElementById('editDate').value = data.date;

                            editForm.action = `/edit_transaction/${id}`;
                            editModal.style.display = 'flex';
                        } else {
                            alert('Error al cargar datos');
                        }
                    })
                    .catch(err => console.error(err));
            }

            window.deleteTransaction = function (id) {
                if (confirm('¿Estás seguro de que deseas eliminar este movimiento? Esta acción no se puede deshacer.')) {
                    fetch(`/delete_transaction/${id}`, { method: 'POST' })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                location.reload();
                            } else {
                                alert('Error al eliminar');
                            }
                        });
                }
            }

            // --- FIN GRÁFICOS ---

            // --- CALENDARIO LÓGICA ---
            let currentDate = new Date();
            const calendarGrid = document.getElementById('calendarGrid');
            const calendarMonthYear = document.getElementById('calendarMonthYear');
            const prevMonthBtn = document.getElementById('prevMonth');
            const nextMonthBtn = document.getElementById('nextMonth');

            // New Details IDs
            const selectedDateInfo = document.getElementById('selectedDateInfo'); // Header Container
            const detailBannerDay = document.getElementById('detailBannerDay');
            const detailBannerMonth = document.getElementById('detailBannerMonth');
            const detailList = document.getElementById('detailList');

            function renderCalendar(date) {
                if (!calendarGrid) return;

                calendarGrid.innerHTML = '';
                const year = date.getFullYear();
                const month = date.getMonth();

                const firstDayIndex = new Date(year, month, 1).getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();

                const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
                calendarMonthYear.textContent = `${monthNames[month]} ${year}`;

                // Empty slots
                for (let i = 0; i < firstDayIndex; i++) {
                    const emptyDiv = document.createElement('div');
                    emptyDiv.classList.add('calendar-day', 'empty');
                    calendarGrid.appendChild(emptyDiv);
                }

                // Days
                for (let i = 1; i <= daysInMonth; i++) {
                    const dayDiv = document.createElement('div');
                    dayDiv.classList.add('calendar-day');
                    dayDiv.textContent = i;

                    const monthStr = (month + 1).toString().padStart(2, '0');
                    const dayStr = i.toString().padStart(2, '0');
                    const fullDate = `${year}-${monthStr}-${dayStr}`;

                    dayDiv.dataset.date = fullDate;

                    // Highlight Today & Auto-Select
                    const today = new Date();
                    if (i === today.getDate() && month === today.getMonth() && year === today.getFullYear()) {
                        dayDiv.classList.add('today');
                        dayDiv.classList.add('selected');
                        // Use setTimeout to ensure DOM is ready or just call directly
                        setTimeout(() => showDayDetails(fullDate), 0);
                    }

                    // Check for transactions (using global transactions variable)
                    // Note: global transactions is loaded from template but we also calculated dailyFlow previously.
                    // We can filter on the fly.
                    const dayT = transactions.filter(t => t.date === fullDate);

                    if (dayT.length > 0) {
                        const dots = document.createElement('div');
                        dots.className = 'dots-container';

                        const hasIncome = dayT.some(t => t.type === 'income');
                        const hasExpense = dayT.some(t => t.type === 'expense');

                        if (hasIncome) {
                            const d = document.createElement('div');
                            d.classList.add('dot', 'income');
                            dots.appendChild(d);
                        }
                        if (hasExpense) {
                            const d = document.createElement('div');
                            d.classList.add('dot', 'expense');
                            dots.appendChild(d);
                        }
                        dayDiv.appendChild(dots);
                    }

                    // Click Event
                    dayDiv.addEventListener('click', () => {
                        document.querySelectorAll('.calendar-day').forEach(d => d.classList.remove('selected'));
                        dayDiv.classList.add('selected');
                        showDayDetails(fullDate);
                    });

                    calendarGrid.appendChild(dayDiv);
                }
            }

            function showDayDetails(dateStr) {
                const dayTransactions = transactions.filter(t => t.date === dateStr);
                const [y, m, d] = dateStr.split('-');

                const dateObj = new Date(y, m - 1, d);
                const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];

                // Update Header
                if (detailBannerDay) detailBannerDay.textContent = d;
                if (detailBannerMonth) detailBannerMonth.textContent = `${monthNames[parseInt(m) - 1]} ${y}`;

                // Update List
                if (!detailList) return;
                detailList.innerHTML = '';

                if (dayTransactions.length > 0) {
                    dayTransactions.forEach(t => {
                        // Icon Logic
                        let icon = 'bi-grid';
                        if (t.category === 'Comida') icon = 'bi-basket';
                        else if (t.category === 'Transporte') icon = 'bi-car-front';
                        else if (t.category === 'Vivienda') icon = 'bi-house-heart';
                        else if (t.category === 'Salud') icon = 'bi-heart-pulse';
                        else if (t.category === 'Entretenimiento') icon = 'bi-music-note-beamed';
                        else if (t.category === 'Salario') icon = 'bi-cash-coin';

                        const item = document.createElement('div');
                        item.className = 'timeline-item fade-in';

                        const amountClass = t.type === 'income' ? 'text-success' : 'text-danger';
                        const sign = t.type === 'income' ? '+' : '-';

                        item.innerHTML = `
                                <div class="timeline-icon-box">
                                    <i class="bi ${icon}"></i>
                                </div>
                                <div class="timeline-content">
                                    <h6 class="mb-1 fw-bold text-main" style="color:var(--text-main)">${t.title}</h6>
                                    <p class="mb-0 text-muted small">${t.category}</p>
                                    <span class="t-amount-lg ${amountClass}">${sign}$${new Intl.NumberFormat('en-US', { minimumFractionDigits: 2 }).format(t.amount)}</span>
                                </div>
                            `;
                        detailList.appendChild(item);
                    });
                } else {
                    detailList.innerHTML = `
                            <div class="details-empty-state fade-in">
                                <i class="bi bi-calendar-range"></i>
                                <p>No hay movimientos.</p>
                            </div>
                        `;
                }

                // Always append the "Programar" button at the bottom

                // Logic to determine text based on date
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                // Create date from dateStr (YYYY-MM-DD) in local time
                const [yearStr, monthStr, dayStr] = dateStr.split('-');
                const checkDate = new Date(parseInt(yearStr), parseInt(monthStr) - 1, parseInt(dayStr));

                let btnText = "Programar movimiento";
                let modalTitle = "Programar movimiento";
                let btnIcon = "bi-calendar-plus";

                if (checkDate < today) {
                    btnText = "Registrar movimiento pasado";
                    modalTitle = "Registrar movimiento pasado";
                    btnIcon = "bi-clock-history";
                } else if (checkDate.getTime() === today.getTime()) {
                    btnText = "Registrar movimiento de hoy";
                    modalTitle = "Registrar movimiento de hoy";
                    btnIcon = "bi-plus-circle";
                }

                const scheduleBtnContainer = document.createElement('div');
                scheduleBtnContainer.className = 'mt-4 text-center fade-in';
                scheduleBtnContainer.innerHTML = `
                        <button class="btn btn-outline-primary rounded-pill w-100 py-2" onclick="openScheduleModal('${dateStr}', '${modalTitle}')">
                            <i class="bi ${btnIcon} me-2"></i> ${btnText}
                        </button>
                    `;
                detailList.appendChild(scheduleBtnContainer);
            }

            // Function to open Schedule Modal
            window.openScheduleModal = function (dateStr, title) {
                const modal = document.getElementById('schedule-modal');
                const dateInput = document.getElementById('scheduleDateInput');
                const dateDisplay = document.getElementById('scheduleDateDisplay');
                const modalTitleElem = modal.querySelector('h3');

                // Format date for display (DD/MM/YYYY)
                const [y, m, d] = dateStr.split('-');
                const displayStr = `${d}/${m}/${y}`;

                dateInput.value = dateStr;
                dateDisplay.textContent = `Para el ${displayStr}`;
                if (title) modalTitleElem.textContent = title;

                modal.style.display = 'flex';
            }

            if (prevMonthBtn && nextMonthBtn) {
                prevMonthBtn.addEventListener('click', () => {
                    currentDate.setMonth(currentDate.getMonth() - 1);
                    renderCalendar(currentDate);
                });

                nextMonthBtn.addEventListener('click', () => {
                    currentDate.setMonth(currentDate.getMonth() + 1);
                    renderCalendar(currentDate);
                });
            }

            // Initial Render
            renderCalendar(currentDate);

            // Loader Logic (Robust)
            const loader = document.getElementById('loader-screen');
            if (loader) {
                const loaderText = loader.querySelector('p');
                const urlParams = new URLSearchParams(window.location.search);
                const isNewUser = urlParams.get('new_user');

                if (isNewUser && loaderText) {
                    loaderText.innerText = "Preparando tu entorno financiero...";
                    setTimeout(() => {
                        loader.style.opacity = '0';
                        setTimeout(() => loader.style.display = 'none', 500);
                    }, 2500);
                } else {
                    setTimeout(() => {
                        loader.style.opacity = '0';
                        setTimeout(() => loader.style.display = 'none', 500);
                    }, 1000);
                }
            }

            const logoutBtn = document.querySelector('.logout-btn');
            const modal = document.getElementById('logout-modal');
            const cancelBtn = document.getElementById('cancel-logout');
            const confirmBtn = document.getElementById('confirm-logout');

            // Show Modal
            if (logoutBtn) {
                logoutBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    modal.style.display = 'flex';
                });
            }

            // Hide Modal
            if (cancelBtn) {
                cancelBtn.addEventListener('click', () => {
                    modal.style.display = 'none';
                });
            }

            // Handle Confirmation
            if (confirmBtn) {
                confirmBtn.addEventListener('click', () => {
                    window.location.href = "{{ url_for('logout') }}";
                });
            }

            // Close on outside click
            window.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.style.display = 'none';
                }
            });


        });

        // Dropdown Logic
        const profileBtn = document.getElementById('userProfileBtn');
        const profileDropdown = document.getElementById('profileDropdown');
        const logoutInfoDrop = document.getElementById('logoutInfoDrop');
        const profileChevron = document.getElementById('profileChevron');

        profileBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            profileDropdown.classList.toggle('show');
            if (profileChevron) profileChevron.classList.toggle('rotate-180');
        });

        // Prevent closing when clicking inside the dropdown
        if (profileDropdown) {
            profileDropdown.addEventListener('click', (e) => {
                e.stopPropagation();
            });
        }

        // Close dropdown on outside click
        window.addEventListener('click', (e) => {
            if (!profileBtn.contains(e.target)) {
                profileDropdown.classList.remove('show');
                if (profileChevron) profileChevron.classList.remove('rotate-180');
            }

            const helpModal = document.getElementById('help-modal');
            if (e.target === helpModal) {
                helpModal.style.display = 'none';
            }

            // Close Subscription Modal on Outside Click
            const subModal = document.getElementById('subscription-modal');
            if (e.target === subModal) {
                subModal.style.display = 'none';
            }
        });

        // Tab Switching Logic
        window.switchMovTab = function (tabName) {
            const transView = document.getElementById('mov-tab-trans');
            const subsView = document.getElementById('mov-tab-subs');
            const btnTrans = document.getElementById('tab-btn-trans');
            const btnSubs = document.getElementById('tab-btn-subs');

            if (tabName === 'trans') {
                transView.classList.remove('d-none');
                subsView.classList.add('d-none');
                btnTrans.classList.add('active');
                btnSubs.classList.remove('active');
            } else {
                transView.classList.add('d-none');
                subsView.classList.remove('d-none');
                btnTrans.classList.remove('active');
                btnSubs.classList.add('active');
            }
        }


        // Bind Logout Modal to Dropdown Link
        if (logoutInfoDrop) {
            logoutInfoDrop.addEventListener('click', (e) => {
                e.preventDefault();
                const modal = document.getElementById('logout-modal');
                if (modal) modal.style.display = 'flex';
            });
        }

        // Mobile Sidebar Logic
        const openSidebarBtn = document.getElementById('openSidebar');
        const closeSidebarBtn = document.getElementById('closeSidebar');
        const sidebar = document.querySelector('.sidebar');
        const mainWrapper = document.querySelector('.main-wrapper');

        // Create backdrop
        const backdrop = document.createElement('div');
        backdrop.className = 'sidebar-backdrop';
        document.body.appendChild(backdrop);

        function toggleSidebar() {
            sidebar.classList.toggle('active');
            backdrop.classList.toggle('active');
            // Prevent body scroll when sidebar open on mobile
            if (sidebar.classList.contains('active')) {
                document.body.style.overflow = 'hidden';
            } else {
                document.body.style.overflow = '';
            }
        }

        if (openSidebarBtn) openSidebarBtn.addEventListener('click', toggleSidebar);
        if (closeSidebarBtn) closeSidebarBtn.addEventListener('click', toggleSidebar);
        backdrop.addEventListener('click', () => {
            sidebar.classList.remove('active');
            backdrop.classList.remove('active');
        });

        // SPA Navigation Logic
        window.showSection = function (sectionId) {
            event.preventDefault();

            // Hide all sections
            const sections = document.querySelectorAll('.content-body');
            sections.forEach(sec => sec.classList.add('d-none'));

            // Show target section
            const target = document.getElementById('section-' + sectionId);
            if (target) {
                target.classList.remove('d-none');
                // Scroll to top of content
                window.scrollTo({
                    top: 0,
                    behavior: 'smooth'
                });
            }

            // Update active sidebar state
            const navLinks = document.querySelectorAll('.nav-link');
            navLinks.forEach(link => link.classList.remove('active'));

            // Find the clicked link (handled by the caller mostly, but strictly we can infer)
            // Simplest way: The user clicked a link, we need to set THAT link as active.
            // Since we are using an onclick, 'event.currentTarget' works if we pass event.
            if (event.currentTarget) {
                event.currentTarget.classList.add('active');
            }

            // Mobile sidebar close on navigation
            if (window.innerWidth <= 992) {
                sidebar.classList.remove('active');
                backdrop.classList.remove('active');
                document.body.style.overflow = ''; // Re-enable scrolling
            }

            // Save state to localStorage to persist on reload (optional, good UX)
            localStorage.setItem('activeSection', sectionId);

            // FIX: Re-render charts to force animation and correct sizing
            if (sectionId === 'dashboard') {
                setTimeout(() => {
                    if (window.renderDashboardCharts) window.renderDashboardCharts();
                }, 50);
            }
        };

        // Restore active section on load
        const savedSection = localStorage.getItem('activeSection') || 'dashboard';
        // If it was movements, simulate click or just show
        // We need to be careful: if the user just logged in or came from index, maybe default to dashboard?
        // Let's assume dashboard default if not found
        if (savedSection !== 'dashboard') {
            // Manually trigger the show logic without event
            const sections = document.querySelectorAll('.content-body');
            sections.forEach(sec => sec.classList.add('d-none'));
            const target = document.getElementById('section-' + savedSection);
            if (target) target.classList.remove('d-none');

            // Update sidebar active class logic manually
            const navLinks = document.querySelectorAll('.nav-link');
            navLinks.forEach(link => {
                link.classList.remove('active');
                if (link.getAttribute('onclick') && link.getAttribute('onclick').includes(savedSection)) {
                    link.classList.add('active');
                }
            });
        }

        // Toggle Logic for Premium Form
        window.updateToggle = function (element) {
            const isExpense = element.value === 'expense';
            const labelExpense = document.getElementById('label-expense');
            const labelIncome = document.getElementById('label-income');

            if (isExpense) {
                labelExpense.classList.add('active-expense');
                labelIncome.classList.remove('active-income');
            } else {
                labelExpense.classList.remove('active-expense');
                labelIncome.classList.add('active-income');
            }
        }

        // Password Visibility Toggle
        window.togglePasswordVisibility = function (inputId, icon) {
            const input = document.getElementById(inputId);
            if (input.type === 'password') {
                input.type = 'text';
                icon.classList.remove('bi-eye-slash');
                icon.classList.add('bi-eye');
            } else {
                input.type = 'password';
                icon.classList.remove('bi-eye');
                icon.classList.add('bi-eye-slash');
            }
        }
        // Help Modal Logic
        window.openHelpModal = function (type) {
            const modal = document.getElementById('help-modal');
            const title = document.getElementById('helpTitle');
            const text = document.getElementById('helpText');

            if (type === 'savings') {
                title.textContent = 'Tasa de ahorro';
                text.textContent = 'Este porcentaje representa cuánto de tus ingresos totales has logrado ahorrar. Se calcula como: (Ingresos - Gastos) / Ingresos.';
            } else if (type === 'category') {
                title.textContent = 'Categoría top';
                text.textContent = 'Es la categoría de gastos donde has destinado más dinero durante este mes. Te ayuda a identificar fugas de dinero.';
            } else if (type === 'surplus') {
                title.textContent = 'Días positivos';
                text.textContent = 'Cuenta los días del mes en los que tus ingresos fueron mayores a tus gastos, o en los que no gastaste nada (Días de gasto cero).';
            }

            modal.style.display = 'flex';
        }

        // Close Help Modal on Outside Click
        window.addEventListener('click', (e) => {
            const helpModal = document.getElementById('help-modal');
            if (e.target === helpModal) {
                helpModal.style.display = 'none';
            }
        });

        // --- INSIGHT MODALS LOGIC ---
        // (Moved to #section-ai-assistant to ensure localized scope and updated capitalization)


        // --- FAQ MODAL FUNCTIONS ---
        window.openFAQModal = function () {
            document.getElementById('faq-modal').style.display = 'flex';
        }

        window.closeFAQModal = function () {
            document.getElementById('faq-modal').style.display = 'none';
        }

        // --- GOALS FUNCTIONS ---
        let goalIdToDelete = null;

        window.openGoalModal = function () {
            const modal = document.getElementById('add-goal-modal');
            const today = new Date().toISOString().split('T')[0];
            modal.querySelector('input[name="target_date"]').setAttribute('min', today);
            modal.style.display = 'flex';
        }

        // --- GENERIC MODAL FUNCTIONS ---
        let onConfirmAction = null;

        window.openConfirmationModal = function (title, message, confirmBtnText, action) {
            document.getElementById('conf-modal-title').textContent = title;
            document.getElementById('conf-modal-msg').textContent = message;
            const btn = document.getElementById('conf-modal-btn');
            btn.textContent = confirmBtnText || 'Confirmar';
            // Store the action
            onConfirmAction = action;
            document.getElementById('confirmation-modal').style.display = 'flex';
        }

        window.closeConfirmationModal = function () {
            document.getElementById('confirmation-modal').style.display = 'none';
            onConfirmAction = null;
        }

        document.getElementById('conf-modal-btn').addEventListener('click', function () {
            if (onConfirmAction) onConfirmAction();
            closeConfirmationModal();
        });

        window.openAlertModal = function (title, message, isError = false) {
            document.getElementById('alert-modal-title').textContent = title;
            document.getElementById('alert-modal-msg').textContent = message;
            const icon = document.getElementById('alert-modal-icon');
            const wrapper = document.getElementById('alert-icon-wrapper');

            if (isError) {
                icon.className = 'bi bi-x-circle-fill text-danger fs-1';
                wrapper.style.background = 'rgba(239, 68, 68, 0.1)';
            } else {
                icon.className = 'bi bi-check-circle-fill text-success fs-1';
                wrapper.style.background = 'rgba(16, 185, 129, 0.1)';
            }
            document.getElementById('alert-modal').style.display = 'flex';
        }

        window.closeAlertModal = function () {
            document.getElementById('alert-modal').style.display = 'none';
            // Resume Carousel Animation
            const track = document.querySelector('.insights-vertical-track');
            if (track) track.style.animationPlayState = 'running';
        }

        // --- GOALS FUNCTIONS (Updated) ---

        window.deleteGoal = function (id) {
            goalIdToDelete = id;
            document.getElementById('delete-goal-modal').style.display = 'flex';
        }

        window.closeDeleteGoalModal = function () {
            document.getElementById('delete-goal-modal').style.display = 'none';
            goalIdToDelete = null;
        }

        document.getElementById('confirmDeleteGoalBtn').addEventListener('click', function () {
            if (goalIdToDelete) {
                fetch(`/delete_savings_goal/${goalIdToDelete}`, { method: 'POST' })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) location.reload();
                        else window.openAlertModal('Error', 'No se pudo eliminar la meta', true);
                    });
            }
        });

        window.openAddFundsModal = function (id, name, amount = null) {
            document.getElementById('fundGoalName').textContent = `Meta: ${name}`;
            document.getElementById('addFundsForm').action = `/add_funds_to_goal/${id}`;
            const amountInput = document.querySelector('#addFundsForm input[name="amount"]');
            if (amount) {
                amountInput.value = amount;
            } else {
                amountInput.value = '';
            }
            document.getElementById('add-funds-modal').style.display = 'flex';
        }

        window.extendGoal = function (id) {
            window.openConfirmationModal(
                '¿Extender plazo?',
                'Esto sumará 30 días a la fecha objetivo.',
                'Sí, extender',
                function () {
                    fetch(`/extend_savings_goal/${id}`, { method: 'POST' })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) location.reload();
                            else window.openAlertModal('Error', 'No se pudo procesar la solicitud', true);
                        });
                }
            );
        }

        // --- OVERRIDE/DEFINE GLOBAL DELETE FINCTIONS ---
        window.deleteTransaction = function (id) {
            window.openConfirmationModal(
                '¿Eliminar movimiento?',
                'Esta acción no se puede deshacer.',
                'Eliminar',
                function () {
                    fetch(`/delete_transaction/${id}`, { method: 'POST' })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) location.reload();
                            else window.openAlertModal('Error', 'No se pudo eliminar el movimiento', true);
                        });
                }
            );
        }

        window.deleteSubscription = function (id) {
            window.openConfirmationModal(
                '¿Cancelar suscripción?',
                'Dejará de cobrarse automáticamente, pero el historial se mantendrá.',
                'Cancelar suscripción',
                function () {
                    fetch(`/delete_subscription/${id}`, { method: 'POST' })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) location.reload();
                            else window.openAlertModal('Error', 'No se pudo eliminar', true);
                        });
                }
            );
        }

        window.deleteBudget = function (id) {
            window.openConfirmationModal(
                '¿Eliminar presupuesto?',
                'Esta acción no se puede deshacer.',
                'Eliminar',
                function () {
                    fetch(`/delete_budget/${id}`, { method: 'POST' })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) location.reload();
                            else window.openAlertModal('Error', 'No se pudo eliminar el presupuesto', true);
                        });
                }
            );
        }

        // Close modals on outside click (Generalized)
        window.addEventListener('click', (e) => {
            const modals = [
                'add-goal-modal', 'add-funds-modal', 'delete-goal-modal',
                'subscription-modal', 'confirmation-modal', 'alert-modal', 'faq-modal'
            ];
            modals.forEach(id => {
                const m = document.getElementById(id);
                if (m && e.target === m) {
                    m.style.display = 'none';
                    // Special case for alert modal to resume carousel
                    if (id === 'alert-modal') {
                        const track = document.querySelector('.insights-vertical-track');
                        if (track) track.style.animationPlayState = 'running';
                    }
                }
            });
        });


        // Intercept Add Funds Form Submission
        const addFundsForm = document.getElementById('addFundsForm');
        if (addFundsForm) {
            addFundsForm.addEventListener('submit', function (e) {
                e.preventDefault();
                const formData = new FormData(this);
                const actionUrl = this.action;

                fetch(actionUrl, {
                    method: 'POST',
                    body: formData
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            document.getElementById('add-funds-modal').style.display = 'none';

                            // Custom Alert Action for Reload
                            const alertBtn = document.querySelector('#alert-modal button');
                            const originalOnClick = alertBtn.onclick; // Save original

                            alertBtn.onclick = function () {
                                location.reload();
                            };

                            window.openAlertModal('¡Abono exitoso!', 'Se han agregado los fondos correctamente.', false);
                        } else {
                            window.openAlertModal('Error', data.message || 'Error al abonar', true);
                        }
                    })
                    .catch(err => {
                        console.error(err);
                        window.openAlertModal('Error', 'Ocurrió un error inesperado', true);
                    });
            });
        }

        // --- TOAST NOTIFICATIONS ---
        window.showToast = function (title, message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;

            let icon = 'bi-info-circle-fill';
            if (type === 'success') icon = 'bi-check-circle-fill';
            if (type === 'error') icon = 'bi-x-circle-fill';

            toast.innerHTML = `
            <i class="bi ${icon} fs-4 text-${type === 'error' ? 'danger' : (type === 'success' ? 'success' : 'primary')}"></i>
            <div class="toast-content">
                <div class="toast-title">${title}</div>
                <div class="toast-message">${message}</div>
            </div>
            <button class="toast-close" onclick="this.parentElement.remove()">&times;</button>
            <div class="toast-progress"></div>
            `;

            container.appendChild(toast);

            // Audio Feedback (Subtle)
            // const audio = new Audio('/static/multimedia/notification.mp3'); // Optional
            // audio.play().catch(e => {});

            // Auto Remove
            setTimeout(() => {
                toast.style.animation = 'fadeOutRight 0.5s ease-out forwards';
                setTimeout(() => toast.remove(), 500);
            }, 4000);
        }

        // Process Flash Messages
        const flashMessagesElem = document.getElementById('flash-messages');
        if (flashMessagesElem) {
            try {
                const messages = JSON.parse(flashMessagesElem.textContent);
                messages.forEach(([category, message]) => {
                    const type = category === 'success' ? 'success' : 'error';
                    const title = category === 'success' ? '¡Éxito!' : 'Atención';
                    showToast(title, message, type);
                });
            } catch (e) {
                console.error("Error parsing flash messages", e);
            }
        }



        // --- GLOBAL BUTTON LOADING STATE ---
        document.addEventListener('submit', function (e) {
            const form = e.target;
            const submitBtn = form.querySelector('button[type="submit"]');

            if (submitBtn && !form.getAttribute('data-no-loading')) {
                // Check validity first (if browser validation is used)
                if (form.checkValidity()) {
                    submitBtn.classList.add('btn-loading');
                    const originalText = submitBtn.innerHTML;
                    // Optional: Restore after timeout if it's an AJAX form (prevent eternal spin)
                    // But for normal submits, page reload will clear it.
                }
            }
        });
    </script>
</div>
</div>
<!-- Add Budget Modal -->
<div id="add-budget-modal" class="modal-overlay">
    <div class="modal-content">
        <h3>Nuevo presupuesto</h3>
        <p>Define un límite mensual para una categoría.</p>
        <form action="{{ url_for('add_budget') }}" method="POST">

            <div class="mb-3">
                <label class="form-label text-start d-block text-muted small fw-bold">Categoría</label>
                <div class="input-group-premium">
                    <i class="bi bi-tag"></i>
                    <select name="category" class="form-control-premium" required>
                        <option value="" disabled selected>Selecciona...</option>
                        <option value="Comida">Comida</option>
                        <option value="Transporte">Transporte</option>
                        <option value="Vivienda">Vivienda</option>
                        <option value="Entretenimiento">Entretenimiento</option>
                        <option value="Salud">Salud</option>
                        <option value="Educación">Educación</option>
                        <option value="Servicios">Servicios</option>
                        <option value="Otros">Otros</option>
                    </select>
                </div>
            </div>

            <div class="mb-4">
                <label class="form-label text-start d-block text-muted small fw-bold">Límite Mensual</label>
                <div class="input-group-premium">
                    <i class="bi bi-currency-dollar"></i>
                    <input type="number" step="0.01" name="amount" class="form-control-premium" placeholder="0.00"
                        required>
                </div>
            </div>

            <div class="modal-actions">
                <button type="button" class="btn-cancel"
                    onclick="document.getElementById('add-budget-modal').style.display='none'">Cancelar</button>
                <button type="submit" class="btn-confirm">Guardar Límite</button>
            </div>
        </form>
    </div>
</div>

<!-- Ensure click outside closes this specific modal too -->
<script>
    document.getElementById('add-budget-modal').addEventListener('click', function (e) {
        if (e.target === this) {
            this.style.display = 'none';
        }
    });
</script>


<!-- Edit Budget Modal -->
<div id="edit-budget-modal" class="modal-overlay">
    <div class="modal-content">
        <h3>Editar presupuesto</h3>
        <p>Ajusta el límite mensual para <span id="edit-budget-cat-name" class="fw-bold">...</span></p>
        <form id="editBudgetForm" method="POST">

            <div class="mb-4">
                <label class="form-label text-start d-block text-muted small fw-bold">Nuevo Límite
                    Mensual</label>
                <div class="input-group-premium">
                    <i class="bi bi-currency-dollar"></i>
                    <input type="number" step="0.01" name="amount" id="edit-budget-amount" class="form-control-premium"
                        placeholder="0.00" required>
                </div>
            </div>

            <div class="modal-actions">
                <button type="button" class="btn-cancel"
                    onclick="document.getElementById('edit-budget-modal').style.display='none'">Cancelar</button>
                <button type="submit" class="btn-confirm">Guardar Cambios</button>
            </div>
        </form>
    </div>
</div>

<script>
    document.getElementById('edit-budget-modal').addEventListener('click', function (e) {
        if (e.target === this) {
            this.style.display = 'none';
        }
    });

    window.openEditBudgetModal = function (id, category, amount) {
        const modal = document.getElementById('edit-budget-modal');
        document.getElementById('edit-budget-cat-name').textContent = category;
        document.getElementById('edit-budget-amount').value = amount;
        document.getElementById('editBudgetForm').action = `/edit_budget/${id}`;
        modal.style.display = 'flex';
    }
</script>

<!-- Generic Alert Modal (Used by Insights and Errors) -->
<div id="alert-modal" class="modal-overlay" style="z-index: 10000;">
    <div class="modal-content" style="max-width: 400px; text-align: center;">
        <div class="mb-3">
            <i class="bi bi-info-circle-fill text-primary fs-1"></i>
        </div>
        <h3 id="alert-modal-title" class="fw-bold mb-3">Aviso</h3>
        <div id="alert-modal-msg" class="text-muted mb-4" style="line-height: 1.6;">
            <!-- Content injected via JS -->
        </div>
        <div class="modal-actions justify-content-center">
            <button type="button" class="btn-confirm"
                onclick="document.getElementById('alert-modal').style.display='none'">Entendido</button>
        </div>
    </div>
</div>

<!-- Help Modal (Generic) -->
<div id="help-modal" class="modal-overlay">
    <div class="modal-content">
        <h3 id="helpTitle">Ayuda</h3>
        <p id="helpText" class="text-muted"></p>
        <div class="modal-actions justify-content-center">
            <button class="btn-confirm"
                onclick="document.getElementById('help-modal').style.display='none'">Cerrar</button>
        </div>
    </div>
</div>

<!-- Confirmation Modal -->
<div id="confirmation-modal" class="modal-overlay">
    <div class="modal-content">
        <h3 id="conf-modal-title">Confirmar</h3>
        <p id="conf-modal-msg">¿Estás seguro?</p>
        <div class="modal-actions">
            <button class="btn-cancel"
                onclick="document.getElementById('confirmation-modal').style.display='none'">Cancelar</button>
            <button id="conf-modal-btn" class="btn-delete">Confirmar</button>
        </div>
    </div>
</div>

<script>
    function showReportLoader() {
        const loader = document.getElementById('loader-screen');
        const textArea = loader.querySelector('.loader-text');

        // Save original text if not already saved (optional safety)
        if (!loader.dataset.originalText) {
            loader.dataset.originalText = textArea.innerText;
        }

        textArea.innerText = "Generando reporte...";
        loader.style.display = 'flex';
        // Force reflow to ensure transition works if needed
        void loader.offsetWidth;
        loader.style.opacity = '1';

        // Hide after 4 seconds to give time for the server request and download start
        setTimeout(() => {
            loader.style.opacity = '0';
            setTimeout(() => {
                loader.style.display = 'none';
                if (loader.dataset.originalText) {
                    textArea.innerText = loader.dataset.originalText;
                }
            }, 500);
        }, 4000);
    }
</script>
{% endblock %}