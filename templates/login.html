{% extends 'base.html' %}
{% block title %}Iniciar Sesión - FinanzApp{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/iniciar_sesion.css') }}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
{% endblock %}

{% block content %}
<div id="loader-screen">
    <svg class="svg-loader" x="0px" y="0px" viewBox="0 0 37 37" preserveAspectRatio="xMidYMid meet">
        <path class="track" fill="none" stroke-width="5" pathLength="100"
            d="M36.63 31.746 c0 -13.394 -7.3260000000000005 -25.16 -18.13 -31.375999999999998 C7.696 6.66 0.37 18.352 0.37 31.746 c5.328 3.108 11.544 4.8839999999999995 18.13 4.8839999999999995 S31.301999999999996 34.854 36.63 31.746z">
        </path>
        <path class="car" fill="none" stroke-width="5" pathLength="100"
            d="M36.63 31.746 c0 -13.394 -7.3260000000000005 -25.16 -18.13 -31.375999999999998 C7.696 6.66 0.37 18.352 0.37 31.746 c5.328 3.108 11.544 4.8839999999999995 18.13 4.8839999999999995 S31.301999999999996 34.854 36.63 31.746z">
        </path>
    </svg>
    <p class="loader-text">Iniciando sesión segura...</p>
</div>

<div class="contenedor">
    <div class="lado-izquierdo">
        <div class="formulario">
            <div class="text-center mb-4 d-md-none">
                <img src="{{ url_for('static', filename='multimedia/logo.png') }}" style="width: 60px;">
            </div>
            <h2>Bienvenido/a</h2>
            <p>Ingresa tus credenciales para continuar. <br>¿No tienes cuenta? <a
                    href="{{ url_for('register') }}">Regístrate gratis</a></p>

            <form id="loginForm">
                <input type="email" placeholder="Correo electrónico" name="email" required id="email" maxlength="100">
                <div class="input-container">
                    <input type="password" id="password" name="password" placeholder="Contraseña" required
                        maxlength="25">
                    <span id="eye-icon-password" class="fa fa-eye"
                        onclick="togglePasswordVisibility('password')"></span>
                </div>
                <button type="submit" class="boton-principal">Iniciar sesión</button>

                <div class="separator">o continúa con</div>

                <a href="{{ url_for('google_login') }}" class="boton-google">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" width="24px" height="24px">
                        <path fill="#FFC107"
                            d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24c0,11.045,8.955,20,20,20c11.045,0,20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z" />
                        <path fill="#FF3D00"
                            d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z" />
                        <path fill="#4CAF50"
                            d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z" />
                        <path fill="#1976D2"
                            d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.571c0.001-0.001,0.002-0.001,0.003-0.002l6.19,5.238C36.971,39.205,44,34,44,24C44,22.659,43.862,21.35,43.611,20.083z" />
                    </svg> Google
                </a>
            </form>
        </div>
    </div>

    <div class="lado-derecho">
        <div class="logo-overlay">
            <img src="{{ url_for('static', filename='multimedia/logo.png') }}" alt="FinanzApp">
        </div>
        <video autoplay loop muted playsinline>
            <source src="{{ url_for('static', filename='multimedia/video_login.mp4') }}" type="video/mp4">
        </video>
        <a href="{{ url_for('index') }}" class="boton-volver">
            <i class="fas fa-arrow-left"></i> Volver al inicio
        </a>
    </div>
</div>

<!-- Alerts -->
<div id="error-message-overlay" class="error-message-overlay">
    <div class="error-message-box">
        <p id="error-message-text"></p>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    function togglePasswordVisibility(id) {
        const input = document.getElementById(id);
        const icon = document.getElementById('eye-icon-' + id);
        if (input.type === "password") {
            input.type = "text"; icon.classList.replace('fa-eye', 'fa-eye-slash');
        } else {
            input.type = "password"; icon.classList.replace('fa-eye-slash', 'fa-eye');
        }
    }

    document.getElementById('loginForm').addEventListener('submit', function (e) {
        e.preventDefault();
        const loader = document.getElementById('loader-screen');
        loader.style.display = 'flex';

        fetch('/login', { method: 'POST', body: new FormData(this) })
            .then(r => {
                if (!r.ok) { throw new Error('Server returned ' + r.status); }
                return r.json();
            })
            .then(data => {
                loader.style.display = 'none';
                if (data.success) window.location.href = data.redirect;
                else {
                    const errBox = document.getElementById('error-message-overlay');
                    document.getElementById('error-message-text').innerText = data.message;
                    errBox.classList.add('show');
                    setTimeout(() => errBox.classList.remove('show'), 3000);
                }
            })
            .catch(error => {
                loader.style.display = 'none';
                console.error('Error:', error);
                const errBox = document.getElementById('error-message-overlay');
                document.getElementById('error-message-text').innerText = "Ocurrió un error inesperado, intenta nuevamente.";
                errBox.classList.add('show');
                setTimeout(() => errBox.classList.remove('show'), 3000);
            });
    });
</script>
{% endblock %}